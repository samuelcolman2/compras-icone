<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login | Ícone (Acesso restrito)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="shortcut icon" href="https://storage.googleapis.com/ecdt-logo-saida/1ebe52af502e25d3521cb9dad62bb72f6bc1c347353cdda5fa381ef8627a9eb8/COLEGIO-E-CURSO-ICONE.webp" type="image/x-icon">

  <style>
    :root {
      --brand: #F1663C;
      --white: #FFFFFF;
      --ok: #22c55e;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background-color: var(--white);
      font-family: 'Inter', sans-serif;
      color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 80vh;
    }

    .logo-top { margin-bottom: 24px; text-align: center; }
    .logo-top img { height: 130px; filter: drop-shadow(0 8px 20px rgba(241,102,60,.25)); }

    .card {
      background-color: var(--brand);
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      padding: 40px 32px;
      width: 100%;
      max-width: 420px;
      text-align: center;
    }

    h1 { font-size: 22px; font-weight: 700; color: var(--white); margin-bottom: 24px; }

    .google-btn {
      width: 100%; padding: 14px; border: none; border-radius: 8px;
      font-size: 15px; font-weight: 600; color: var(--brand); background: var(--white);
      display: flex; align-items: center; justify-content: center; gap: 10px;
      cursor: pointer; transition: all 0.2s ease;
    }
    .google-btn:hover { filter: brightness(0.95); transform: translateY(-1px); }

    .google-icon { width: 20px; height: 20px; }

    .notice { font-size: 13px; margin-top: 16px; color: var(--white); min-height: 18px; }
    .ok { color: var(--ok); }
    .err { color: var(--danger); }

    .profile {
      display: none; align-items: center; justify-content: space-between;
      background: rgba(255,255,255,0.15); border-radius: 10px; padding: 10px 14px;
      margin-top: 18px; color: var(--white);
    }
    .avatar {
      height: 40px; width: 40px; border-radius: 50%; object-fit: cover;
      border: 2px solid rgba(255,255,255,0.4);
    }
    .signout {
      background: none; border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px; color: var(--white); padding: 6px 12px; cursor: pointer;
    }

    .legal { color: var(--white); font-size: 12px; margin-top: 20px; }
    .legal a { color: var(--white); text-decoration: underline; }
  </style>
</head>
<body>
  <!-- Logo fora do box -->
  <div class="logo-top">
    <img src="https://iconecolegioecurso.com.br/wp-content/uploads/2022/08/xlogo_icone_site.png.pagespeed.ic_.QgXP3GszLC.webp" alt="Logo Ícone" />
  </div>

  <main class="card">
    <h1>Área de Acesso</h1>

    <button id="googleBtn" class="google-btn">
      <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
        <path fill="#FFC107" d="M44.5 20H24v8.5h11.8C34.9 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.2-6.2C34.5 4.5 29.5 2.5 24 2.5 12.2 2.5 2.5 12.2 2.5 24S12.2 45.5 24 45.5 45.5 35.8 45.5 24c0-1.4-.1-2.7-.4-4z"/>
        <path fill="#34A853" d="M6.3 33.3l7-5.4C15.1 31.9 19.5 34 24 34c4 0 7.5-1.4 10.2-3.8l6.9 5.6C38.5 40.6 31.9 43.5 24 43.5 14.8 43.5 7.2 38.8 6.3 33.3z"/>
        <path fill="#EA4335" d="M34.2 19.3C33 16.4 29.5 14 24 14c-4.7 0-8.7 2.9-10.7 6.3l-7-5.1C9.2 7.2 16 2.5 24 2.5c5.5 0 10.5 2 14.1 5.7l-6 5.1z"/>
        <path fill="#4285F4" d="M44.5 24c0-1.4-.1-2.7-.4-4H24v8.5h11.8c-.6 3.6-2.3 6.2-4.7 8.1l6.9 5.6c4-3.7 6.5-9.2 6.5-16.2z"/>
      </svg>
      Entrar com Google
    </button>

    <div id="notice" class="notice"></div>

    <div id="profile" class="profile">
      <img id="avatar" class="avatar" alt="Foto do usuário" />
      <span id="displayName"></span>
      <button id="signOutBtn" class="signout">Sair</button>
    </div>

    <p class="legal">
      Ao continuar, você concorda com nossos <a href="#">Termos</a> e <a href="#">Política de Privacidade</a>.
    </p>
  </main>

  <!-- Firebase Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signInWithRedirect,
    getRedirectResult,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAEZidq8mdAUKeJXvSQeE01gVOLWe_cp78",
    authDomain: "compras-icone.firebaseapp.com",
    projectId: "compras-icone",
    storageBucket: "compras-icone.firebasestorage.app",
    messagingSenderId: "831706842201",
    appId: "1:831706842201:web:9b68ae4f98ad93c5a99d48",
  };

  const ALLOWED_DOMAIN = 'icone.g12.br';
  const FORMS_URL = '/forms/';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  auth.languageCode = 'pt'; // opcional: mensagens do Google em pt

  const provider = new GoogleAuthProvider();
  provider.setCustomParameters({ prompt: "select_account", hd: ALLOWED_DOMAIN });

  const googleBtn = document.getElementById('googleBtn');
  const profile = document.getElementById('profile');
  const avatar = document.getElementById('avatar');
  const displayName = document.getElementById('displayName');
  const notice = document.getElementById('notice');
  const signOutBtn = document.getElementById('signOutBtn');

  const isAllowedEmail = (email) => email?.toLowerCase().endsWith('@' + ALLOWED_DOMAIN);

  function showMsg(text, type = '') {
    notice.textContent = text || '';
    notice.className = 'notice' + (type ? ' ' + type : '');
  }

  function friendlyError(code, message) {
    switch (code) {
      case 'auth/popup-blocked': return 'Popup bloqueado. Tente novamente ou use outro navegador.';
      case 'auth/popup-closed-by-user': return 'Popup fechado antes de concluir.';
      case 'auth/cancelled-popup-request': return 'Tentativa de login cancelada.';
      case 'auth/account-exists-with-different-credential':
        return 'Essa conta já existe com outra forma de login.';
      default: return message || 'Falha no login.';
    }
  }

  async function doRedirect() {
    // garante que a página de destino existe
    window.location.replace(FORMS_URL);
  }

  googleBtn.addEventListener('click', async () => {
    showMsg('');
    googleBtn.disabled = true;
    googleBtn.style.opacity = '0.7';

    try {
      // 1) tenta popup
      const result = await signInWithPopup(auth, provider);
      const user = result.user;

      if (!isAllowedEmail(user.email)) {
        await signOut(auth);
        showMsg('Acesso negado. Use sua conta @' + ALLOWED_DOMAIN, 'err');
      } else {
        showMsg('Login realizado com sucesso!', 'ok');
        await doRedirect();
      }
    } catch (e) {
      // 2) fallback para redirect se for erro clássico de popup
      if (e?.code === 'auth/popup-blocked') {
        try {
          await signInWithRedirect(auth, provider);
          return; // o fluxo continua após o redirect
        } catch (e2) {
          showMsg(friendlyError(e2.code, e2.message), 'err');
        }
      } else {
        showMsg(friendlyError(e.code, e.message), 'err');
      }
    } finally {
      googleBtn.disabled = false;
      googleBtn.style.opacity = '1';
    }
  });

  signOutBtn.addEventListener('click', async () => {
    await signOut(auth);
    profile.style.display='none';
    googleBtn.style.display='flex';
  });

  // Trata o retorno do signInWithRedirect (se tiver acontecido)
  getRedirectResult(auth).then((result) => {
    if (!result) return;
    const user = result.user;
    if (!user) return;

    if (!isAllowedEmail(user.email)) {
      signOut(auth);
      showMsg('Acesso negado. Use sua conta @' + ALLOWED_DOMAIN, 'err');
    } else {
      showMsg('Login realizado com sucesso!', 'ok');
      doRedirect();
    }
  }).catch(e => {
    showMsg(friendlyError(e.code, e.message), 'err');
  });

  // Se já estiver autenticado e autorizado, pula o login e vai direto aos forms
  onAuthStateChanged(auth, (user) => {
    if (user && isAllowedEmail(user.email)) {
      doRedirect();
      return;
    }
    // estado visual
    if (user) {
      if (!isAllowedEmail(user.email)) { signOut(auth); return; }
      profile.style.display='flex';
      googleBtn.style.display='none';
      avatar.src = user.photoURL || '';
      displayName.textContent = user.displayName || user.email || '';
    } else {
      profile.style.display='none';
      googleBtn.style.display='flex';
    }
  });
</script>

</body>
</html>
