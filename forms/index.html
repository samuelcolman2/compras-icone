<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Formulário - Ícone Colégio e Curso</title>

  <!-- ===== BLOCO: Fontes & Favicon ===== -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link rel="shortcut icon" href="https://storage.googleapis.com/ecdt-logo-saida/1ebe52af502e25d3521cb9dad62bb72f6bc1c347353cdda5fa381ef8627a9eb8/COLEGIO-E-CURSO-ICONE.webp" type="image/x-icon">

  <!-- ===== BLOCO: Tailwind & Toastify ===== -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <!-- ===== BLOCO: Tailwind Config ===== -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primaria: '#F1663C' },
          boxShadow: { glow: '0 0 0 3px rgba(241,102,60,0.15), 0 10px 25px -5px rgba(0,0,0,0.25)' },
          screens: { xs: '380px' }
        }
      }
    }
  </script>

  <!-- ===== BLOCO: CSS Global & Navbar ===== -->
  <style>
    /* ===== Base ===== */
    html { scroll-behavior: smooth; }
    body { font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Poppins, Arial, sans-serif; color: #000; }
    * { color: #000; }

    /* Toastify (tema claro no site, toasts brancos forçam contraste) */
    .toastify, .toastify * { color: #fff !important; }
    .toastify .toast-close { color: #fff !important; opacity: .9; }

    /* ===== Tema Cantina (variáveis) ===== */
    :root {
      --cantina-primary: #FD7F08;
      --cantina-secondary: #253237;
      --cantina-text: #FD7F08;
      --cantina-border: #e2e8f0;
    }

    /* ===== Navbar Cantina ===== */
    nav.cantina-nav { position: sticky; top: 0; z-index: 50; background: var(--cantina-secondary); border-bottom: 3px solid var(--cantina-primary); color: var(--cantina-text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    nav.cantina-nav .cantina-container { max-width: min(98vw, 1400px); margin: 0 auto; padding: 0 12px; height: 96px; display: flex; align-items: center; justify-content: space-between; }
    nav.cantina-nav a { display: flex; align-items: center; text-decoration: none; }
    nav.cantina-nav img { height: 64px; width: auto; }

    /* Marca */
    nav.cantina-nav .brand { display: flex; align-items: center; gap: 12px; color: var(--cantina-text); height: 100%; }
    nav.cantina-nav .brand .divider { width: 2px; height: 70%; align-self: center; background: var(--cantina-primary); border-radius: 2px; }
    nav.cantina-nav .brand .title { font-weight: 800; letter-spacing: .5px; font-size: clamp(18px, 3.8vw, 32px); line-height: 1.15; white-space: normal; word-break: keep-all; }

    /* ===== Menu Hambúrguer ===== */
    nav.cantina-nav .menu-wrapper { position: relative; display: inline-block; }
    nav.cantina-nav .menu-checkbox { position: absolute; opacity: 0; pointer-events: none; }

    /* Botão */
    nav.cantina-nav .menu-button { display: inline-flex; align-items: center; justify-content: center; width: 44px; height: 44px; border-radius: 10px; cursor: pointer; user-select: none; background-color: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.18); transition: background-color .15s ease, transform .15s ease, box-shadow .15s ease; }
    nav.cantina-nav .menu-button:hover { background-color: rgba(255,255,255,0.12); box-shadow: 0 2px 10px rgba(2,8,23,.5); }
    nav.cantina-nav .menu-button:active { transform: scale(0.96); }
    nav.cantina-nav .menu-button:focus-visible { outline: 2px solid var(--cantina-primary); outline-offset: 2px; }

    /* Ícones */
    nav.cantina-nav .icon { width: 24px; height: 24px; stroke: #fff; }
    nav.cantina-nav .icon-menu { display: block; }
    nav.cantina-nav .icon-close { display: none; }
    nav.cantina-nav .menu-checkbox:checked + label .icon-menu { display: none; }
    nav.cantina-nav .menu-checkbox:checked + label .icon-close { display: block; }

    /* ===== Dropdown ===== */
    nav.cantina-nav .actions { position: absolute; top: calc(100% + 8px); right: 0; z-index: 60; display: none; flex-direction: column; gap: 6px; background: #ffffff; border: 1px solid var(--cantina-border); border-radius: 12px; padding: 5px; width: min(70vw, 150px); box-shadow: 0 24px 60px rgba(2, 8, 23, .45), 0 2px 6px rgba(2, 8, 23, .2); }
    nav.cantina-nav .menu-checkbox:checked ~ .actions { display: flex; }

    /* Botões do dropdown */
    nav.cantina-nav .btn { width: 100%; justify-content: center; border-radius: 8px; padding: 8px 10px; border: 1px solid var(--cantina-border); background: #fff; color: #000; cursor: pointer; transition: background-color .15s ease, box-shadow .15s ease, transform .15s ease; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; text-align: center; font-size: .7rem; line-height: 1.1; }
    nav.cantina-nav .btn:hover { background-color: #f8fafc; box-shadow: 0 2px 8px rgba(0,0,0,.06); transform: translateY(-1px); }
    nav.cantina-nav .btn:focus-visible { outline: 2px solid var(--cantina-primary); outline-offset: 2px; }
    nav.cantina-nav .btn svg { width: 18px; height: 18px; }

    /* ===== Mobile (<=640px) ===== */
    @media (max-width: 640px) {
      nav.cantina-nav .cantina-container { height: 72px; }
      nav.cantina-nav img { height: 48px; }
      nav.cantina-nav .brand { flex: 1; min-width: 0; }
      nav.cantina-nav .menu-button { width: 40px; height: 40px; border-radius: 10px; }
      nav.cantina-nav .icon { width: 20px; height: 20px; }
      nav.cantina-nav .brand .title { font-size: clamp(16px, 5vw, 22px); }
    }

    /* ===== Ajustes do Form ===== */
    #formulario label, #formulario p.font-semibold, #formulario .font-semibold { color: #f1f5f9; }

    /*Diminuindo tamanho dos botões do menu hambúrguer*/
    nav.cantina-nav .actions {padding: 5px; gap: 6px; width: min(70vw, 150px);}
    nav.cantina-nav .btn{width: 100%; justify-content: center; padding: 8px 10px; font-size: 0.7rem; line-height: 1.1; border-radius: 8px; gap: 6px;}
    nav.cantina-nav .btn svg{ width: 18px; height: 18px;}
  </style>
</head>

<body class="min-h-screen text-white antialiased" style="background: var(--cantina-secondary);">
  <!-- ===== BLOCO: Navbar Cantina ===== -->
  <nav class="cantina-nav">
    <div class="cantina-container">
      <a class="brand" href="#">
        <img src="https://iconecolegioecurso.com.br/wp-content/uploads/2022/08/xlogo_icone_site.png.pagespeed.ic_.QgXP3GszLC.webp" alt="Logo Ícone Colégio e Curso" onerror="this.onerror=null;this.src='https://placehold.co/150x50/eeeeee/333333?text=Logo';">
        <span class="divider" aria-hidden="true"></span>
        <span class="title text-[#FD7F08]">FORMULÁRIO DE COMPRAS</span>
      </a>

      <div class="menu-wrapper" id="menuWrapper">
        <input type="checkbox" id="menuCheckbox" class="menu-checkbox" aria-label="Abrir / fechar menu">
        <label id="menuToggle" for="menuCheckbox" class="menu-button" aria-expanded="false" aria-controls="menuActions">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="menu" class="icon icon-menu">
            <line x1="4" y1="6" x2="20" y2="6"></line>
            <line x1="4" y1="12" x2="20" y2="12"></line>
            <line x1="4" y1="18" x2="20" y2="18"></line>
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="x" class="icon icon-close">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </label>

        <div id="menuActions" class="actions">
          <button id="btnSetorCompras" style="display:none" class="btn">Setor Compras</button>
          <button id="btnAdminAprovacao" style="display:none" class="btn">Admin</button>
          <button id="btnDashboards" style="display:none" class="btn">Dashboards</button>
          <button id="btnSair" class="btn" aria-label="Sair" title="Sair">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="log-out" class="lucide lucide-log-out w-6 h-6">
              <path d="m16 17 5-5-5-5"></path>
              <path d="M21 12H9"></path>
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            </svg>
            <span>Sair</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- ===== BLOCO: Âncoras de Navegação Ocultas ===== -->
  <a id="hrefAdminAprovacao" href="/admin/" style="display:none;"></a>
  <a id="hrefAdminCompras" href="/financeiro/" style="display:none;"></a>
  <a id="hrefLogin" href="../index.html" style="display:none;"></a>
  <a id="hrefDashboards" href="/dashboards/" style="display:none;"></a>

  <!-- ===== BLOCO: Main + Formulário ===== -->
  <main class="w-full px-4 sm:px-6 pb-16 mt-6 sm:mt-8">
    <div class="relative max-w-5xl mx-auto">
      <div class="pointer-events-none absolute inset-0 -z-10 hidden sm:block blur-3xl opacity-30" aria-hidden="true">
        <div class="w-56 h-56 lg:w-72 lg:h-72 bg-primaria/30 rounded-full absolute -top-10 -left-10"></div>
        <div class="w-56 h-56 lg:w-72 lg:h-72 bg-orange-300/30 rounded-full absolute bottom-0 right-0"></div>
      </div>

      <form id="formulario" novalidate class="mx-auto bg-[#3A474C] backdrop-blur-xl border border-white/60 shadow-2xl shadow-glow rounded-xl sm:rounded-2xl p-4 xs:p-6 sm:p-8 md:p-10 transition-[transform,box-shadow] hover:shadow-glow hover:-translate-y-0.5 max-w-3xl lg:max-w-4xl">
        <div class="grid grid-cols-1 md:grid-cols-2 md:gap-x-10 gap-y-4">
          <div class="col-esq">
            <label for="nome" class="font-semibold mb-1 block">Nome</label>
            <input type="text" id="nome" name="nome" placeholder="Digite seu nome" required class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none ring-0 focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition" />

            <label for="email" class="font-semibold mb-1 block mt-2">E-mail</label>
            <input type="email" id="email" name="email" placeholder="Digite seu e-mail" required class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none ring-0 focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition" />

            <label for="unidade" class="font-semibold mb-1 block mt-2">Selecione a unidade</label>
            <select id="unidade" name="unidade" required class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition">
              <option value="">Escolha uma unidade</option>
              <option value="1">Unidade 1</option>
              <option value="2">Unidade 2</option>
              <option value="3">Unidade 3</option>
              <option value="4">Unidade 4</option>
              <option value="5">Unidade 5</option>
              <option value="6">Unidade 6</option>
            </select>

            <p class="font-semibold mt-2">Possui prazo?</p>
            <div class="flex flex-wrap items-center gap-4 text-sm sm:text-base">
              <label class="flex items-center gap-2 cursor-pointer select-none">
                <input type="radio" name="prazo" value="sim" class="accent-primaria"> <span>Sim</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer select-none">
                <input type="radio" name="prazo" value="nao" checked class="accent-primaria"> <span>Não</span>
              </label>
            </div>

            <div id="prazoCampos" class="hidden mt-2">
              <label for="dataPrazo" class="font-semibold mb-1 block">Data e hora do prazo</label>
              <input type="datetime-local" id="dataPrazo" name="dataPrazo" class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition" />
            </div>

            <label for="urgencia" class="font-semibold mb-1 block mt-2">Grau de urgência</label>
            <select id="urgencia" name="urgencia" required class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition">
              <option value="">Selecione o grau</option>
              <option value="baixa">Baixa</option>
              <option value="media">Média</option>
              <option value="alta">Alta</option>
              <option value="critica">Crítica</option>
            </select>
          </div>

          <div class="col-dir md:pl-6 md:border-l md:border-white/40">
            <label for="tipo" class="font-semibold mb-1 block">Tipo</label>
            <select id="tipo" name="tipo" required class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition">
              <option value="">Selecione uma opção</option>
              <option value="servico">Serviço</option>
              <option value="produto">Produto</option>
            </select>

            <div id="servicoCampos" class="hidden mt-2">
              <label for="descricaoServico" class="font-semibold mb-1 block">Descrição do serviço</label>
              <textarea id="descricaoServico" name="descricaoServico" placeholder="Descreva o serviço a ser realizado" class="w-full min-h-[90px] rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition resize-y"></textarea>

              <p class="font-semibold mt-2">Tem alguém para indicar?</p>
              <div class="flex flex-wrap items-center gap-4 text-sm sm:text-base" id="temIndicacaoGroup">
                <label class="flex items-center gap-2 cursor-pointer select-none">
                  <input type="radio" name="temIndicacao" value="sim" class="accent-primaria"> <span>Sim</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer select-none">
                  <input type="radio" name="temIndicacao" value="nao" checked class="accent-primaria"> <span>Não</span>
                </label>
              </div>

              <div id="indicacaoQuem" class="hidden mt-2">
                <label for="quemIndicar" class="font-semibold mb-1 block">Quem?</label>
                <input type="text" id="quemIndicar" name="quemIndicar" placeholder="Nome e/ou contato da indicação" class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition" />
              </div>
            </div>

            <div id="produtoCampos" class="hidden mt-2">
              <label for="nomeProduto" class="font-semibold mb-1 block">Produto (nome)</label>
              <input type="text" id="nomeProduto" name="nomeProduto" placeholder="Ex.: Caneca, Banner..." class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition" />

              <label for="quantidadeProduto" class="font-semibold mb-1 block mt-2">Quantidade</label>
              <input type="number" id="quantidadeProduto" name="quantidadeProduto" min="1" step="1" placeholder="Ex.: 100" class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition" />

              <p class="font-semibold mt-2">Tem algum link?</p>
              <div class="flex flex-wrap items-center gap-4 text-sm sm:text-base" id="temLinkGroup">
                <label class="flex items-center gap-2 cursor-pointer select-none">
                  <input type="radio" name="temLink" value="sim" class="accent-primaria"> <span>Sim</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer select-none">
                  <input type="radio" name="temLink" value="nao" checked class="accent-primaria"> <span>Não</span>
                </label>
              </div>

              <div id="linkCampos" class="hidden mt-2">
                <div id="listaLinks" class="space-y-2"></div>
                <button type="button" class="small-btn mt-2 inline-flex w-full xs:w-auto justify-center items-center gap-2 rounded-lg bg-white px-3 py-2 text-sm font-semibold shadow hover:-translate-y-0.5 hover:shadow-md active:translate-y-0 transition" id="adicionarLink">+ Adicionar outro link</button>
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="group mt-6 w-full rounded-xl bg-white text-black font-semibold px-5 py-3 shadow-lg shadow-primaria/30 ring-0 outline-none transition hover:-translate-y-0.5 hover:shadow-xl focus-visible:ring-4 focus-visible:ring-primaria/30">
          <span class="inline-flex items-center gap-2 justify-center">Enviar
            <svg class="size-5 transition-transform group-hover:translate-x-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.25 8.25L21 12l-3.75 3.75M21 12H3" />
            </svg>
          </span>
        </button>
      </form>
    </div>
  </main>

  <!-- ===== BLOCO: Firebase Auth + Níveis de Acesso ===== -->
  <script type="module">
    // [SEÇÃO] SDK e Configuração
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAEZidq8mdAUKeJXvSQeE01gVOLWe_cp78",
      authDomain: "compras-icone.firebaseapp.com",
      projectId: "compras-icone",
      storageBucket: "compras-icone.firebasestorage.app",
      messagingSenderId: "831706842201",
      appId: "1:831706842201:web:9b68ae4f98ad93c5a99d48"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // [SEÇÃO] Estado Global Compartilhado (visível ao script abaixo)
    window.isUserAuthed = false;
    window.currentUserEmail = null;
    window.currentUserName = null;

    // [SEÇÃO] Listas de Admin (carregadas via JSON)
    let ADMIN_COMPRAS_EMAILS = new Set();
    let ADMIN_APROVACAO_EMAILS = new Set();
    let ADMIN_SUPREMO_EMAILS = new Set();

    async function carregarAdmins() {
      try {
        const resp = await fetch('../config/adminEmails.json', { cache: 'no-cache' });
        if (!resp.ok) return;
        const data = await resp.json();
        ADMIN_APROVACAO_EMAILS = new Set((data.adminAprovacao || []).map(e => e.toLowerCase()));
        ADMIN_COMPRAS_EMAILS = new Set((data.adminCompras || []).map(e => e.toLowerCase()));
        ADMIN_SUPREMO_EMAILS = new Set((data.admSupremo || []).map(e => e.toLowerCase()));
      } catch (_) {}
    }
    await carregarAdmins();

    // [SEÇÃO] Referências de UI
    const btnSair = document.getElementById('btnSair');
    const btnAdminAprovacao = document.getElementById('btnAdminAprovacao');
    const btnSetorCompras = document.getElementById('btnSetorCompras');
    const hrefLogin = document.getElementById('hrefLogin');
    const hrefAdminAprovacao = document.getElementById('hrefAdminAprovacao');
    const hrefAdminCompras = document.getElementById('hrefAdminCompras');
    const btnDashboards = document.getElementById('btnDashboards');
    const hrefDashboards = document.getElementById('hrefDashboards');

    // [SEÇÃO] Preenchimento Automático de Nome/E-mail
    function preencherCamposUsuario() {
      const nomeEl = document.getElementById('nome');
      const emailEl = document.getElementById('email');
      if (!window.isUserAuthed) { if (emailEl) emailEl.readOnly = false; return; }
      if (emailEl) { emailEl.value = window.currentUserEmail || ''; emailEl.readOnly = true; }
      if (nomeEl && !nomeEl.value) { nomeEl.value = window.currentUserName || ''; }
    }
    window.preencherCamposUsuario = preencherCamposUsuario;

    // [SEÇÃO] Ações do Header
    btnSair?.addEventListener('click', async (e) => {
      e.preventDefault();
      try { await signOut(auth); } catch (_) {}
      try { localStorage.removeItem('sessionUser'); } catch (_) {}
      window.isUserAuthed = false; window.currentUserEmail = null; window.currentUserName = null;
      if (btnAdminAprovacao) btnAdminAprovacao.style.display = 'none';
      if (btnSetorCompras) btnSetorCompras.style.display = 'none';
      if (btnDashboards) btnDashboards.style.display = 'none';
      preencherCamposUsuario();
      if (hrefLogin) hrefLogin.click(); else location.href = '../index.html';
    });

    btnAdminAprovacao?.addEventListener('click', (e) => { e.preventDefault(); if (hrefAdminAprovacao) hrefAdminAprovacao.click(); else location.href = '/admin/'; });
    btnDashboards?.addEventListener('click', (e) => { e.preventDefault(); if (hrefDashboards) hrefDashboards.click(); else location.href = '/dashboards/'; });
    btnSetorCompras?.addEventListener('click', (e) => { e.preventDefault(); if (hrefAdminCompras) hrefAdminCompras.click(); else location.href = '/financeiro/'; });

    // [SEÇÃO] Login e Nível de Acesso
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.isUserAuthed = false; window.currentUserEmail = null; window.currentUserName = null;
        if (btnAdminAprovacao) btnAdminAprovacao.style.display = 'none';
        if (btnSetorCompras) btnSetorCompras.style.display = 'none';
        if (btnDashboards) btnDashboards.style.display = 'none';
        preencherCamposUsuario();
        return;
      }
      window.isUserAuthed = true; window.currentUserEmail = user.email || ''; window.currentUserName = user.displayName || '';
      preencherCamposUsuario();
      const emailLower = (user.email || '').toLowerCase();
      const isAprovacao = ADMIN_APROVACAO_EMAILS.has(emailLower);
      const isCompras = ADMIN_COMPRAS_EMAILS.has(emailLower);
      const isSupremo = ADMIN_SUPREMO_EMAILS.has(emailLower);
      if (btnAdminAprovacao) btnAdminAprovacao.style.display = (isSupremo || isAprovacao) ? 'inline-flex' : 'none';
      if (btnSetorCompras) btnSetorCompras.style.display = (isSupremo || isCompras) ? 'inline-flex' : 'none';
      if (btnDashboards) btnDashboards.style.display = isSupremo ? 'inline-flex' : 'none';
    });
  </script>

  <!-- ===== BLOCO: Lógica do Formulário & Envio ===== -->
  <script>
    // [SEÇÃO] Referências do Form
    const form = document.getElementById('formulario');
    const radiosPrazo = document.getElementsByName('prazo');
    const prazoCampos = document.getElementById('prazoCampos');
    const inputDataPrazo = document.getElementById('dataPrazo');
    const selectTipo = document.getElementById('tipo');
    const servicoCampos = document.getElementById('servicoCampos');
    const descricaoServico = document.getElementById('descricaoServico');
    const temIndicacaoGroup = document.getElementById('temIndicacaoGroup');
    const indicacaoQuem = document.getElementById('indicacaoQuem');
    const quemIndicar = document.getElementById('quemIndicar');
    const produtoCampos = document.getElementById('produtoCampos');
    const nomeProduto = document.getElementById('nomeProduto');
    const quantidadeProduto = document.getElementById('quantidadeProduto');
    const temLinkGroup = document.getElementById('temLinkGroup');
    const linkCampos = document.getElementById('linkCampos');
    const listaLinks = document.getElementById('listaLinks');
    const btnAddLink = document.getElementById('adicionarLink');
    const menuWrapper = document.getElementById('menuWrapper');
    const menuCheckbox = document.getElementById('menuCheckbox');
    const menuToggleLabel = document.getElementById('menuToggle');

    // [SEÇÃO] Estado Interno
    let linkCount = 0; const maxLinks = 3; let isSubmitting = false;

    // [SEÇÃO] Toast Utilitário
    function toast(msg, type = 'info') {
      const isSuccess = type === 'success';
      const isError = type === 'error';
      Toastify({
        text: msg,
        duration: 3500,
        close: true,
        gravity: "top",
        position: "right",
        stopOnFocus: true,
        style: {
          background: isSuccess ? "linear-gradient(90deg,#16a34a,#22c55e)" : isError ? "linear-gradient(90deg,#dc2626,#ef4444)" : "linear-gradient(90deg,#334155,#64748b)",
          color: "#ffffff",
          fontWeight: "600",
          boxShadow: "0 10px 25px -10px rgba(0,0,0,.35)",
          borderRadius: "10px",
          padding: "10px 16px"
        },
        offset: { x: 8, y: 10 }
      }).showToast();
    }

    // [SEÇÃO] Links Dinâmicos
    function atualizarBotaoAddLink() { if (!btnAddLink) return; btnAddLink.style.display = linkCount >= maxLinks ? "none" : "inline-flex"; }
    function atualizarPlaceholders() { const inputs = listaLinks.querySelectorAll('input[type="url"]'); inputs.forEach((i, idx) => i.placeholder = `Cole o link ${idx + 1}`); }
    function criarCampoLink() {
      linkCount++;
      const div = document.createElement('div');
      div.className = 'flex items-center gap-2';
      if (linkCount === 1) {
        div.innerHTML = `<input type="url" name="linkProduto${linkCount}" placeholder="Cole o link ${linkCount}" required class="flex-1 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition"/>`;
      } else {
        div.innerHTML = `
          <input type="url" name="linkProduto${linkCount}" placeholder="Cole o link ${linkCount}" required class="flex-1 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm sm:text-base outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20 transition"/>
          <button type="button" class="grid place-items-center rounded-full w-7 h-7 bg-white text-primaria border border-primaria/30 shadow hover:scale-105 active:scale-100 transition remove-link" aria-label="Remover link">&times;</button>
        `;
        div.querySelector('.remove-link').addEventListener('click', () => { div.remove(); linkCount--; atualizarBotaoAddLink(); atualizarPlaceholders(); });
      }
      listaLinks.appendChild(div);
      atualizarBotaoAddLink();
    }

    // [SEÇÃO] Trocas de UI (Prazo/Tipo/Indicação/Link)
    function atualizarPrazo() {
      const selecionado = [...radiosPrazo].find(r => r.checked)?.value;
      if (selecionado === 'sim') { prazoCampos.classList.remove('hidden'); inputDataPrazo.required = true; }
      else { prazoCampos.classList.add('hidden'); inputDataPrazo.required = false; inputDataPrazo.value = ''; }
    }
    function atualizarTipo() {
      if (selectTipo.value === 'servico') {
        servicoCampos.classList.remove('hidden'); descricaoServico.required = true;
        produtoCampos.classList.add('hidden'); nomeProduto.required = false; nomeProduto.value = ''; quantidadeProduto.required = false; quantidadeProduto.value = '';
        document.querySelector('input[name="temLink"][value="nao"]').checked = true; linkCampos.classList.add('hidden'); listaLinks.innerHTML = ''; linkCount = 0; atualizarBotaoAddLink();
      } else if (selectTipo.value === 'produto') {
        produtoCampos.classList.remove('hidden'); nomeProduto.required = true; quantidadeProduto.required = true;
        servicoCampos.classList.add('hidden'); descricaoServico.required = false; descricaoServico.value = '';
        document.querySelector('input[name="temIndicacao"][value="nao"]').checked = true; indicacaoQuem.classList.add('hidden'); quemIndicar.required = false; quemIndicar.value = '';
      } else { servicoCampos.classList.add('hidden'); produtoCampos.classList.add('hidden'); }
    }
    function atualizarIndicacao() {
      const temIndicacao = document.querySelector('input[name="temIndicacao"]:checked')?.value;
      if (temIndicacao === 'sim') { indicacaoQuem.classList.remove('hidden'); quemIndicar.required = false; }
      else { indicacaoQuem.classList.add('hidden'); quemIndicar.required = false; quemIndicar.value = ''; }
    }
    function atualizarLink() {
      const temLink = document.querySelector('input[name="temLink"]:checked')?.value;
      if (temLink === 'sim') { linkCampos.classList.remove('hidden'); if (linkCount === 0) criarCampoLink(); }
      else { linkCampos.classList.add('hidden'); listaLinks.innerHTML = ''; linkCount = 0; atualizarBotaoAddLink(); }
    }

    radiosPrazo.forEach(r => r.addEventListener('change', atualizarPrazo)); atualizarPrazo();
    selectTipo.addEventListener('change', atualizarTipo); atualizarTipo();
    temIndicacaoGroup.addEventListener('change', atualizarIndicacao);
    temLinkGroup.addEventListener('change', atualizarLink);
    btnAddLink?.addEventListener('click', () => { if (linkCount < maxLinks) { criarCampoLink(); atualizarPlaceholders(); } });

    // [SEÇÃO] Backend (Google Apps Script via URL do config)
    let WEBAPP_URL = '';
    async function carregarConfigBackend() {
      try {
        const resp = await fetch('../config/appConfig.json', { cache: 'no-cache' });
        if (!resp.ok) return;
        const data = await resp.json();
        WEBAPP_URL = data.WEBAPP_URL || '';
      } catch (_) {}
    }
    carregarConfigBackend();

    // [SEÇÃO] Coleta & Reset de UI
    function coletarLinks() { const inputs = listaLinks.querySelectorAll('input[type="url"]'); const arr = []; inputs.forEach(i => { const v = i.value.trim(); if (v) arr.push(v); }); return arr; }
    function resetarUIPosEnvioOtimista() {
      form.reset();
      linkCount = 0; listaLinks.innerHTML = ''; atualizarBotaoAddLink();
      const prazoNao = document.querySelector('input[name="prazo"][value="nao"]');
      const indicacaoNao = document.querySelector('input[name="temIndicacao"][value="nao"]');
      const temLinkNao = document.querySelector('input[name="temLink"][value="nao"]');
      if (prazoNao) prazoNao.checked = true; if (indicacaoNao) indicacaoNao.checked = true; if (temLinkNao) temLinkNao.checked = true;
      atualizarPrazo(); atualizarTipo(); atualizarIndicacao(); atualizarLink();
      if (typeof window.preencherCamposUsuario === 'function') window.preencherCamposUsuario();
    }

    // [SEÇÃO] Envio ao Backend
    async function enviarParaPlanilha(payload) {
      const body = new URLSearchParams(payload);
      let ok = false; let parseOk = false;
      if (!WEBAPP_URL) return false;
      try {
        const resp = await fetch(WEBAPP_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' }, body });
        if (resp.type === 'opaque') ok = true; else {
          let data = null; try { data = await resp.json(); parseOk = true; } catch (_) {}
          ok = resp.ok && (parseOk ? (data?.ok !== false) : true);
        }
      } catch (_) {
        try { await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' }, body }); ok = true; } catch (_) { ok = false; }
      }
      return ok;
    }

    // [SEÇÃO] Submit do Form (UX Otimista + validações)
    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      if (!window.isUserAuthed) { toast('Você precisa estar logado para enviar.', 'error'); return; }
      if (!WEBAPP_URL) { toast('Conectando ao setor de compras... tente novamente em 1 segundo.', 'error'); return; }
      if (isSubmitting) return; isSubmitting = true;

      const nome = document.getElementById('nome').value.trim();
      const email = document.getElementById('email').value.trim();
      const unidade = document.getElementById('unidade').value;
      const urgencia = document.getElementById('urgencia').value;
      const prazoSelecionado = [...radiosPrazo].find(r => r.checked)?.value;
      const dataPrazo = inputDataPrazo.value;
      const tipo = selectTipo.value;

      if (!nome || !email || !unidade || !urgencia || !tipo) { toast('Preencha todos os campos obrigatórios.', 'error'); isSubmitting = false; return; }
      if (prazoSelecionado === 'sim' && !dataPrazo) { toast('Por favor, selecione a data e hora do prazo.', 'error'); isSubmitting = false; return; }
      if (tipo === 'servico' && !descricaoServico.value.trim()) { toast('Descreva o serviço.', 'error'); isSubmitting = false; return; }
      if (tipo === 'produto') {
        if (!nomeProduto.value.trim()) { toast('Informe o nome do produto.', 'error'); isSubmitting = false; return; }
        if (!quantidadeProduto.value || Number(quantidadeProduto.value) < 1) { toast('Informe a quantidade (mínimo 1).', 'error'); isSubmitting = false; return; }
      }

      const payload = {
        nome,
        email,
        unidade,
        prazo: prazoSelecionado,
        dataPrazo,
        urgencia,
        tipo,
        descricaoServico: (tipo === 'servico') ? (descricaoServico.value.trim() || '') : '',
        temIndicacao: (tipo === 'servico') ? (document.querySelector('input[name="temIndicacao"]:checked')?.value || 'nao') : '',
        quemIndicar: (tipo === 'servico') ? (quemIndicar.value.trim() || '') : '',
        nomeProduto: (tipo === 'produto') ? (nomeProduto.value.trim() || '') : '',
        quantidadeProduto: (tipo === 'produto') ? (quantidadeProduto.value || '') : '',
        links: (tipo === 'produto' && document.querySelector('input[name="temLink"]:checked')?.value === 'sim') ? JSON.stringify(coletarLinks()) : JSON.stringify([])
      };

      payload.submissionId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));

      toast('Pedido enviado com sucesso!', 'success');
      resetarUIPosEnvioOtimista();
      isSubmitting = false;

      const ok = await enviarParaPlanilha(payload);
      if (!ok) { toast('Erro ao enviar. Tente novamente.', 'error'); }
    });

    // [SEÇÃO] Acessibilidade Menu (fechar ao clicar fora/resize)
    function closeMenu() { if (menuCheckbox.checked) { menuCheckbox.checked = false; if (menuToggleLabel) menuToggleLabel.setAttribute('aria-expanded', 'false'); } }
    menuToggleLabel?.addEventListener('click', () => { setTimeout(() => { menuToggleLabel.setAttribute('aria-expanded', String(menuCheckbox.checked)); }, 0); });
    document.addEventListener('click', (e) => { if (!menuWrapper.contains(e.target)) closeMenu(); });
    window.addEventListener('resize', () => { closeMenu(); });
  </script>
</body>
</html>
