<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dashboards • Compras</title>

  <!-- ===== BLOCO: Fontes & Favicon ===== -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link rel="shortcut icon" href="https://storage.googleapis.com/ecdt-logo-saida/1ebe52af502e25d3521cb9dad62bb72f6bc1c347353cdda5fa381ef8627a9eb8/COLEGIO-E-CURSO-ICONE.webp" type="image/x-icon">

  <!-- ===== BLOCO: Tailwind & Chart.js ===== -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { primaria: '#F1663C' }, boxShadow: { glow: '0 0 0 3px rgba(241,102,60,0.15), 0 10px 25px -5px rgba(0,0,0,0.25)' }, screens: { xs: '380px' } } } }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ===== Preferência inicial de tema (evita flash) ===== -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      }catch(e){ document.documentElement.setAttribute('data-theme', 'dark'); }
    })();
  </script>

  <!-- ===== BLOCO: CSS Global & Navbar ===== -->
  <style>
    html{scroll-behavior:smooth}
    /* ===== Paleta por tema ===== */
    :root{
      --cantina-primary:#FD7F08; /* laranja/acento */
      --cantina-secondary:#253237; /* fundo nav/geral (escuro) */
      --cantina-text:#FD7F08;      /* texto da marca no nav */
      --cantina-border:rgba(255,255,255,.6);

      --bg:#253237;              /* fundo da página */
      --text:#f1f5f9;            /* texto principal */
      --muted:#94a3b8;           /* textos auxiliares */
      --card-bg:#3A474C;         /* fundo de cartões/modal */
      --card-border:rgba(255,255,255,.6);
    }
    [data-theme="light"]{
      --cantina-secondary:#ffffff;
      --cantina-text:#0f172a;
      --cantina-border:#e2e8f0;

      --bg:#f8fafc;
      --text:#0f172a;
      --muted:#475569;
      --card-bg:#ffffff;
      --card-border:#e2e8f0;
    }

    body{font-family:'Roboto',system-ui,-apple-system,Segoe UI,Poppins,Arial,sans-serif; color:var(--text) !important; background:var(--bg)}
    *{box-sizing:border-box}

    /* ===== Navbar ===== */
    nav.cantina-nav{position:sticky;top:0;z-index:50;background:var(--cantina-secondary);border-bottom:3px solid var(--cantina-primary);color:var(--cantina-text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    nav.cantina-nav .cantina-container{max-width:min(98vw,1400px);margin:0 auto;padding:0 12px;height:96px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    nav.cantina-nav a{text-decoration:none;display:flex;align-items:center}
    nav.cantina-nav img{height:64px;width:auto}
    nav.cantina-nav .brand{display:flex;align-items:center;gap:12px;color:var(--cantina-text);height:100%}
    nav.cantina-nav .brand .divider{width:2px;height:70%;align-self:center;background:var(--cantina-primary);border-radius:2px}
    nav.cantina-nav .brand .title{font-weight:800;letter-spacing:.5px;font-size:clamp(18px,3.8vw,32px);line-height:1.15;white-space:normal;word-break:keep-all;color:var(--cantina-text)}

    /* Botões de topo (hambúrguer + tema) */
    nav.cantina-nav .menu-checkbox{position:absolute;opacity:0;pointer-events:none}
    nav.cantina-nav .menu-button, .theme-toggle{display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:10px;cursor:pointer;user-select:none;transition:background-color .15s ease,transform .15s ease,box-shadow .15s ease,border-color .15s ease}
    nav.cantina-nav .menu-button{background-color:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18)}
    nav.cantina-nav .menu-button:hover{background-color:rgba(255,255,255,.12);box-shadow:0 2px 10px rgba(2,8,23,.5)}
    nav.cantina-nav .menu-button:active{transform:scale(.96)}
    nav.cantina-nav .menu-button:focus-visible{outline:2px solid var(--cantina-primary);outline-offset:2px}
    nav.cantina-nav .icon{width:24px;height:24px;stroke:currentColor}
    nav.cantina-nav .icon-menu{display:block}
    nav.cantina-nav .icon-close{display:none}
    nav.cantina-nav .menu-checkbox:checked+label .icon-menu{display:none}
    nav.cantina-nav .menu-checkbox:checked+label .icon-close{display:block}
    /* Dá margem só no botão de tema */
    nav.cantina-nav .menu-button + .theme-toggle{ margin-left: 8px; }


    /* Theme toggle (sol/lua) */
    .theme-toggle{background-color:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);color:#fff}
    .theme-toggle:hover{background-color:rgba(255,255,255,.12);box-shadow:0 2px 10px rgba(2,8,23,.5)}
    .theme-toggle:active{transform:scale(.96)}
    .theme-toggle:focus-visible{outline:2px solid var(--cantina-primary);outline-offset:2px}
    .theme-toggle .icon-sun, .theme-toggle .icon-moon{width:22px;height:22px}
    [data-theme="dark"] .theme-toggle .icon-sun{display:none}
    [data-theme="dark"] .theme-toggle .icon-moon{display:block}
    [data-theme="light"] .theme-toggle{background-color:rgba(2,8,23,.06);border-color:rgba(2,8,23,.12);color:#0f172a}
    [data-theme="light"] .theme-toggle .icon-sun{display:block}
    [data-theme="light"] .theme-toggle .icon-moon{display:none}

    /* Dropdown */
    nav.cantina-nav .actions{position:absolute;top:calc(100% + 8px);right:0;z-index:60;display:none;flex-direction:column;gap:6px;background:#fff;border:1px solid var(--cantina-border);border-radius:12px;padding:10px;width:min(70vw,180px);box-shadow:0 24px 60px rgba(2,8,23,.45),0 2px 6px rgba(2,8,23,.2)}
    nav.cantina-nav .menu-checkbox:checked~.actions{display:flex}
    nav.cantina-nav .btn{width:100%;justify-content:center;border-radius:10px;padding:10px 12px;border:1px solid var(--cantina-border);background:#fff;color:#000;cursor:pointer;transition:background-color .15s ease,box-shadow .15s ease,transform .15s ease;font-weight:600;display:inline-flex;align-items:center;gap:6px;text-align:center}
    nav.cantina-nav .btn:hover{background-color:#f8fafc;box-shadow:0 2px 8px rgba(0,0,0,.06);transform:translateY(-1px)}
    nav.cantina-nav .btn:focus-visible{outline:2px solid var(--cantina-primary);outline-offset:2px}
    [data-theme="light"] nav.cantina-nav .icon{color:#0f172a}


    nav.cantina-nav .menu-wrapper{position: relative; display: inline-flex; align-items: center; }
    nav.cantina-nav .actions {left: 0; right: auto; top: calc(100% + 8px);}


    @media (max-width:640px){
      nav.cantina-nav .cantina-container{height:72px}
      nav.cantina-nav img{height:48px}
      nav.cantina-nav .brand{flex:1;min-width:0}
      nav.cantina-nav .menu-button,.theme-toggle{width:40px;height:40px;border-radius:10px}
      nav.cantina-nav .icon{width:20px;height:20px}
      nav.cantina-nav .brand .title{font-size:clamp(16px,5vw,22px)}
    }

    /* ===== Cartões / conteúdos ===== */
    .card-dark{background:var(--card-bg) !important; border:1px solid var(--card-border) !important; color:var(--text)}
    .card-dark *{color:var(--text)}
    .card-dark select option{color:#000!important;background-color:#fff!important}
    .card-dark select{color:var(--text)}
    .kpi-card{cursor:pointer;transition:transform .15s ease,box-shadow .15s ease}
    .kpi-card:hover{transform:scale(1.03);box-shadow:0 0 0 3px rgba(253,127,8,.2),0 20px 40px -10px rgba(0,0,0,.6)}

    /* Ajustes de texto quando claro (sobrepõe utilitários Tailwind usados no HTML) */
    [data-theme="light"] .text-white{color:#0f172a !important}
    [data-theme="light"] .text-slate-200{color:#334155 !important}
    [data-theme="light"] .text-slate-400{color:#475569 !important}

    /*Diminuindo tamanho dos botões do menu hambúrguer*/
    nav.cantina-nav .actions {padding: 5px; gap: 6px; width: min(70vw, 150px);}
    nav.cantina-nav .btn{width: 100%; justify-content: center; padding: 8px 10px; font-size: 0.7rem; line-height: 1.1; border-radius: 8px; gap: 6px;}
    nav.cantina-nav .btn svg{ width: 18px; height: 18px;}



    /* Borda do botão "Recarregar dados" */
    #btnRecarregar{ border:1px solid rgba(255,255,255,.18); }             /* escuro */
    [data-theme="light"] #btnRecarregar{ border-color:#cbd5e1; }          /* claro */

    /* Borda cinza nos filtros (selects) no modo claro */
    [data-theme="light"] .card-dark select{
      border-color:#cbd5e1 !important;
      background:#fff;
      color:#0f172a;
    }

    /* Evita barra horizontal e força quebra de palavras grandes (e-mails, etc.) */
    #modalOverlay .modal-body td,
    #modalOverlay .modal-body th{
      overflow-wrap:anywhere;      /* equivalente ao Tailwind "break-words" */
      word-break:break-word;
      white-space:normal;
    }

  </style>
</head>

<body class="min-h-screen text-white antialiased" style="background: var(--cantina-secondary);">
  <!-- ===== BLOCO: Navbar Cantina ===== -->
  <nav class="cantina-nav" aria-label="Topo">
    <div class="cantina-container">
      <a class="brand" href="#">
        <img src="https://iconecolegioecurso.com.br/wp-content/uploads/2022/08/xlogo_icone_site.png.pagespeed.ic_.QgXP3GszLC.webp" alt="Logo Ícone Colégio e Curso" onerror="this.onerror=null;this.src='https://placehold.co/150x50/eeeeee/333333?text=Logo';">
        <span class="divider" aria-hidden="true"></span>
        <span class="title text-[#FD7F08]">DASHBOARDS DE COMPRAS</span>
      </a>



      <div class="menu-wrapper" id="menuWrapper">
        <input type="checkbox" id="menuCheckbox" class="menu-checkbox" aria-label="Abrir / fechar menu">
        <label id="menuToggle" for="menuCheckbox" class="menu-button" aria-expanded="false" aria-controls="menuActions">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-menu">
            <line x1="4" y1="6" x2="20" y2="6"></line>
            <line x1="4" y1="12" x2="20" y2="12"></line>
            <line x1="4" y1="18" x2="20" y2="18"></line>
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-close">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </label>

      <!-- Botão tema -->
      <button id="themeToggle" class="theme-toggle" aria-label="Alternar tema claro/escuro" title="Tema claro/escuro">
        <!-- Sol -->
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="4"></circle>
          <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path>
        </svg>
        <!-- Lua -->
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>

        <div id="menuActions" class="actions">
          <button id="btnVoltarForm" class="btn">Formulário</button>
          <button id="btnSair" class="btn" aria-label="Sair" title="Sair">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" data-lucide="log-out"
                class="lucide lucide-log-out w-6 h-6">
              <path d="m16 17 5-5-5-5"></path>
              <path d="M21 12H9"></path>
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            </svg>
            <span>Sair</span>
          </button>
        </div>

      </div>
    </div>
  </nav>

  <!-- ===== BLOCO: Âncoras de Navegação Ocultas ===== -->
  <a id="hrefForm" href="../forms/" style="display:none;"></a>
  <a id="hrefLogin" href="../index.html" style="display:none;"></a>

  <!-- ===== BLOCO: Overlay de Carregamento ===== -->
  <div id="loadingOverlay" class="fixed inset-0 z-[200] hidden grid place-items-center bg-black/60 backdrop-blur-sm">
    <div class="flex flex-col items-center gap-3">
      <svg class="animate-spin size-10 text-[#FD7F08]" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
        <path d="M4 12a8 8 0 0 1 8-8" stroke="currentColor" stroke-width="4" stroke-linecap="round" class="opacity-100"></path>
      </svg>
      <p class="text-slate-100 text-sm font-medium">Atualizando dados…</p>
    </div>
  </div>

  <!-- ===== BLOCO: Main ===== -->
  <main class="w-full px-4 sm:px-6 pb-20 pt-6 sm:pt-8">
    <div class="max-w-6xl mx-auto space-y-8">
      <section class="space-y-4 sm:space-y-6">
        <div class="card-dark rounded-xl border shadow-2xl shadow-glow p-4 sm:p-6 flex flex-col gap-4">
          <div class="flex flex-col gap-4 sm:flex-row sm:flex-wrap sm:items-end">
            <div class="flex-1 min-w-[150px]">
              <label for="filtroTipo" class="block text-slate-200 text-xs font-medium mb-1">Tipo do pedido</label>
              <select id="filtroTipo" class="w-full rounded-lg bg-white/10 border border-white/40 text-slate-100 text-sm px-3 py-2 pr-8 appearance-none focus:outline-none focus:ring-2 focus:ring-[#FD7F08] focus:border-transparent">
                <option value="" selected>Todos</option>
                <option value="produto">Produtos</option>
                <option value="servico">Serviços</option>
              </select>
            </div>
            <div class="flex-1 min-w-[150px]">
              <label for="filtroUnidade" class="block text-slate-200 text-xs font-medium mb-1">Unidade</label>
              <select id="filtroUnidade" class="w-full rounded-lg bg-white/10 border border-white/40 text-slate-100 text-sm px-3 py-2 pr-8 appearance-none focus:outline-none focus:ring-2 focus:ring-[#FD7F08] focus:border-transparent">
                <option value="">Todas as unidades</option>
              </select>
            </div>
            <div class="flex-1 min-w-[150px]">
              <label for="filtroMes" class="block text-slate-200 text-xs font-medium mb-1">Mês (data do pedido)</label>
              <select id="filtroMes" class="w-full rounded-lg bg-white/10 border border-white/40 text-slate-100 text-sm px-3 py-2 pr-8 appearance-none focus:outline-none focus:ring-2 focus:ring-[#FD7F08] focus:border-transparent">
                <option value="">Todos os meses</option>
              </select>
            </div>
            <div class="sm:self-end">
              <button id="btnRecarregar" class="rounded-lg bg-white text-black text-sm font-semibold px-3 py-2 shadow hover:-translate-y-0.5 hover:shadow-md active:translate-y-0 transition">Recarregar dados</button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-4 sm:gap-6">
          <div id="cardValorGasto" class="kpi-card card-dark rounded-xl border shadow-2xl shadow-glow p-4 sm:p-6 flex flex-col">
            <span id="labelValorGasto" class="text-slate-200 text-sm font-medium">Custo total (R$)</span>
            <span class="text-white text-3xl font-semibold leading-tight mt-1" id="kpiValorGasto">--</span>
            <span id="descValorGasto" class="text-slate-400 text-xs mt-2">Somatório de produtos comprados</span>
          </div>
          <div id="cardQtdPedidos" class="kpi-card card-dark rounded-xl border shadow-2xl shadow-glow p-4 sm:p-6 flex flex-col">
            <span id="labelQtdPedidos" class="text-slate-200 text-sm font-medium">Solicitações de produto</span>
            <span class="text-white text-3xl font-semibold leading-tight mt-1" id="kpiQtdPedidos">--</span>
            <span id="descQtdPedidos" class="text-slate-400 text-xs mt-2">Total de solicitações registradas</span>
          </div>
          <div id="cardQtdAprovados" class="kpi-card card-dark rounded-xl border shadow-2xl shadow-glow p-4 sm:p-6 flex flex-col">
            <span id="labelQtdAprovados" class="text-slate-200 text-sm font-medium">Solicitações aprovadas</span>
            <span class="text-white text-3xl font-semibold leading-tight mt-1" id="kpiQtdAprovados">--</span>
            <span id="descQtdAprovados" class="text-slate-400 text-xs mt-2">Calculado: total − reprovadas</span>
          </div>
          <div id="cardQtdRejeicoes" class="kpi-card card-dark rounded-xl border shadow-2xl shadow-glow p-4 sm:p-6 flex flex-col">
            <span id="labelQtdRejeicoes" class="text-slate-200 text-sm font-medium">Solicitações reprovadas</span>
            <span class="text-white text-3xl font-semibold leading-tight mt-1" id="kpiQtdRejeicoes">--</span>
            <span id="descQtdRejeicoes" class="text-slate-400 text-xs mt-2">Produtos/serviços não aprovados</span>
          </div>
          <div id="cardQtdComprados" class="kpi-card card-dark rounded-xl border shadow-2xl shadow-glow p-4 sm:p-6 flex flex-col">
            <span id="labelQtdComprados" class="text-slate-200 text-sm font-medium">Itens comprados</span>
            <span class="text-white text-3xl font-semibold leading-tight mt-1" id="kpiQtdComprados">--</span>
            <span id="descQtdComprados" class="text-slate-400 text-xs mt-2">Status “comprado” (produto/serviço)</span>
          </div>
        </div>
      </section>

      <section class="card-dark rounded-xl border shadow-2xl shadow-glow p-4 sm:p-6 md:p-8">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
          <h2 class="text-white font-semibold text-lg sm:text-xl flex items-center gap-2">
            <span class="text-[#FD7F08]">Gasto por unidade</span>
            <span class="text-slate-400 text-xs font-normal">(valor comprado)</span>
          </h2>
        </div>
        <div class="mt-6 w-full overflow-x-auto">
          <div class="min-w-[300px]">
            <canvas id="graficoGastoPorUnidade" class="w-full h-[260px]"></canvas>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- ===== BLOCO: Modal de Detalhe KPI ===== -->
  <div id="modalOverlay" class="fixed inset-0 bg-black/70 z-[100] hidden flex items-center justify-center p-4">
    <div class="card-dark rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col">
      <div class="flex items-start justify-between p-4 border-b" style="border-color: var(--card-border)">
        <div>
          <h3 id="modalTitulo" class="text-white text-lg font-semibold"></h3>
          <p id="modalDescricao" class="text-slate-400 text-xs mt-1 leading-snug"></p>
        </div>
        <button id="modalFechar" class="text-red-500 hover:text-red-400 focus:outline-none focus:ring-2 focus:ring-red-500/40 text-2xl leading-none font-extrabold px-2 rounded-md" aria-label="Fechar modal">×</button>
      </div>
      <div class="modal-body overflow-y-auto overflow-x-hidden p-4 text-sm">
        <table class="w-full table-fixed text-left text-slate-100 text-xs sm:text-sm">
          <thead id="modalThead" class="text-slate-400 uppercase border-b" style="border-color: var(--card-border)"></thead>
          <tbody id="modalTbody" class="align-top divide-y" style="border-color: var(--card-border)"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== BLOCO: Menu Hambúrguer (comportamento) ===== -->
  <script>
    const menuWrapper = document.getElementById('menuWrapper');
    const menuCheckbox = document.getElementById('menuCheckbox');
    const menuToggleLabel = document.getElementById('menuToggle');
    function closeMenu(){ if(menuCheckbox.checked){ menuCheckbox.checked=false; menuToggleLabel?.setAttribute('aria-expanded','false'); } }
    menuToggleLabel?.addEventListener('click',()=>{ setTimeout(()=>{ menuToggleLabel.setAttribute('aria-expanded', String(menuCheckbox.checked)); },0); });
    document.addEventListener('click',(e)=>{ if(!menuWrapper.contains(e.target)) closeMenu(); });
    window.addEventListener('resize', closeMenu);

    // ===== Alternância de Tema
    const themeToggleBtn = document.getElementById('themeToggle');
    function getTheme(){ return document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark'; }
    function setTheme(next){ document.documentElement.setAttribute('data-theme', next); try{ localStorage.setItem('theme', next); }catch(_){} updateChartTheme(); }
    themeToggleBtn?.addEventListener('click', ()=>{ setTheme(getTheme()==='dark' ? 'light' : 'dark'); });
  </script>

  <!-- ===== BLOCO: Firebase/Auth + KPIs + Filtros + Gráfico ===== -->
  <script type="module">
    // [SEÇÃO] Imports Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // [SEÇÃO] Config Firebase
    const firebaseConfig = { apiKey: "AIzaSyAEZidq8mdAUKeJXvSQeE01gVOLWe_cp78", authDomain: "compras-icone.firebaseapp.com", projectId: "compras-icone", storageBucket: "compras-icone.firebasestorage.app", messagingSenderId: "831706842201", appId: "1:831706842201:web:9b68ae4f98ad93c5a99d48" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // [SEÇÃO] Backend (Apps Script WebApp)
    let API_BASE = '';
    async function carregarConfigBackend(){ try{ const resp = await fetch('../config/appConfig.json',{cache:'no-cache'}); if(!resp.ok) return; const data = await resp.json(); API_BASE = data.WEBAPP_URL || data.API_BASE || ''; } catch(_){} }
    carregarConfigBackend();

    // [SEÇÃO] Referências DOM
    const btnSair = document.getElementById('btnSair');
    const btnVoltarForm = document.getElementById('btnVoltarForm');
    const hrefForm = document.getElementById('hrefForm');
    const hrefLogin = document.getElementById('hrefLogin');

    const selectUnidade = document.getElementById('filtroUnidade');
    const selectMes = document.getElementById('filtroMes');
    const selectTipo = document.getElementById('filtroTipo');
    const btnRecarregar = document.getElementById('btnRecarregar');

    const kpiValorGasto = document.getElementById('kpiValorGasto');
    const kpiQtdPedidos = document.getElementById('kpiQtdPedidos');
    const kpiQtdAprovados = document.getElementById('kpiQtdAprovados');
    const kpiQtdRejeicoes = document.getElementById('kpiQtdRejeicoes');
    const kpiQtdComprados = document.getElementById('kpiQtdComprados');

    const cardValorGasto = document.getElementById('cardValorGasto');
    const cardQtdPedidos = document.getElementById('cardQtdPedidos');
    const cardQtdAprovados = document.getElementById('cardQtdAprovados');
    const cardQtdRejeicoes = document.getElementById('cardQtdRejeicoes');
    const cardQtdComprados = document.getElementById('cardQtdComprados');

    const labelValorGasto = document.getElementById('labelValorGasto');
    const descValorGasto = document.getElementById('descValorGasto');
    const labelQtdPedidos = document.getElementById('labelQtdPedidos');
    const descQtdPedidos = document.getElementById('descQtdPedidos');
    const labelQtdAprovados = document.getElementById('labelQtdAprovados');
    const descQtdAprovados = document.getElementById('descQtdAprovados');
    const labelQtdRejeicoes = document.getElementById('labelQtdRejeicoes');
    const descQtdRejeicoes = document.getElementById('descQtdRejeicoes');
    const labelQtdComprados = document.getElementById('labelQtdComprados');
    const descQtdComprados = document.getElementById('descQtdComprados');

    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitulo = document.getElementById('modalTitulo');
    const modalDescricao = document.getElementById('modalDescricao');
    const modalThead = document.getElementById('modalThead');
    const modalTbody = document.getElementById('modalTbody');
    const modalFechar = document.getElementById('modalFechar');

    const loadingOverlay = document.getElementById('loadingOverlay');

    const canvasGastoPorUnidade = document.getElementById('graficoGastoPorUnidade');
    const ctxGastoPorUnidade = canvasGastoPorUnidade ? canvasGastoPorUnidade.getContext('2d') : null;

    // [SEÇÃO] Estado
    let allItems = [];
    const detalhesKPIs = { gasto: [], pedidos: [], aprovados: [], rejeicoes: [], comprados: [] };
    let gastoPorUnidadeChart = null;

    // [SEÇÃO] Utils
    function getMonthKey(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); return `${y}-${m}`; }
    function startLoading(btn){ loadingOverlay?.classList.remove('hidden'); if(btn) btn.disabled=true; }
    function stopLoading(btn){ loadingOverlay?.classList.add('hidden'); if(btn) btn.disabled=false; }
    function getMonthLabel(key){ const [yyyy,mmStr]=key.split('-'); const mm=parseInt(mmStr,10); const nomes=['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro']; return `${nomes[mm-1]||mmStr}/${yyyy}`; }
    function parseValorBrToNumber(v){ if(typeof v==='number') return v; if(!v) return 0; let s=String(v).trim(); s=s.replace(/R\$\s?/gi,'').trim(); if(s.includes(',')&&s.includes('.')) s=s.replace(/\./g,'').replace(',', '.'); else if(s.includes(',')&&!s.includes('.')) s=s.replace(',', '.'); const n=parseFloat(s); return isNaN(n)?0:n; }
    function formatBRL(n){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2}).format(n||0); }
    function getNomeItem(it){ return it.nomeProduto||it.descricaoServico||it.produto||it.item||it.descricao||it.descricaoItem||it.itemServico||'(sem descrição)'; }
    function getSolicitante(it){ return it.solicitante||it.nomeSolicitante||it.nome||'(sem solicitante)'; }
    function getAprovador(it){ return it.aprovador||it.aprovadoPor||it.aprovou||'(aprovador não informado)'; }
    function getReprovador(it){ return it.reprovador||it.rejeitadoPor||it.rejeitou||'(reprovador não informado)'; }
    function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
    function getTipoSelecionado(){ return (selectTipo.value||'').trim().toLowerCase(); }

    // ===== Cores por tema para o gráfico
    function themeIsLight(){ return document.documentElement.getAttribute('data-theme')==='light'; }
    function chartColors(){
      const isLight = themeIsLight();
      return {
        text: isLight ? '#0f172a' : '#f1f5f9',
        grid: isLight ? 'rgba(15,23,42,0.1)' : 'rgba(255,255,255,0.15)',
        border: isLight ? 'rgba(15,23,42,0.25)' : 'rgba(255,255,255,0.25)',
        barStroke: isLight ? '#0f172a' : '#ffffff'
      }
    }

    // [SEÇÃO] Filtros
    function popularFiltros(){
      const unidades=new Set(); allItems.forEach(i=>{ const u=String(i.unidade||'').trim(); if(u) unidades.add(u); });
      selectUnidade.innerHTML=''; const optAllU=document.createElement('option'); optAllU.value=''; optAllU.textContent='Todas as unidades'; selectUnidade.appendChild(optAllU);
      Array.from(unidades).sort((a,b)=>a.localeCompare(b,'pt-BR',{numeric:true})).forEach(u=>{ const o=document.createElement('option'); o.value=u; o.textContent=u; selectUnidade.appendChild(o); });
      const meses=new Set(); allItems.forEach(i=>{ if(!i.timestamp) return; const d=new Date(i.timestamp); if(!isNaN(d)) meses.add(getMonthKey(d)); });
      selectMes.innerHTML=''; const optAllM=document.createElement('option'); optAllM.value=''; optAllM.textContent='Todos os meses'; selectMes.appendChild(optAllM);
      Array.from(meses).sort((a,b)=>b.localeCompare(a)).forEach(key=>{ const o=document.createElement('option'); o.value=key; o.textContent=getMonthLabel(key); selectMes.appendChild(o); });
    }

    // [SEÇÃO] Filtragem
    function getItensFiltrados(){
      const unidadeSel=(selectUnidade.value||'').trim();
      const mesSel=(selectMes.value||'').trim();
      const tipoSel=getTipoSelecionado();
      return allItems.filter(item=>{
        const tipoItem=String(item.tipo||'').toLowerCase().trim(); if(tipoSel && tipoItem!==tipoSel) return false;
        if(unidadeSel && String(item.unidade||'').trim()!==unidadeSel) return false;
        if(mesSel){ if(!item.timestamp) return false; const d=new Date(item.timestamp); if(isNaN(d)) return false; if(getMonthKey(d)!==mesSel) return false; }
        return true;
      });
    }

    // [SEÇÃO] KPIs
    function atualizarKPIs(){
      const itens=getItensFiltrados(); const tipoSel=getTipoSelecionado();
      detalhesKPIs.gasto=[]; detalhesKPIs.pedidos=[]; detalhesKPIs.aprovados=[]; detalhesKPIs.rejeicoes=[]; detalhesKPIs.comprados=[];
      const totalPedidos=itens.length; let rejeicoes=0; let valorTotal=0; let compradosCount=0;
      itens.forEach(item=>{
        const st=String(item.status||'').toLowerCase().trim(); const tipoNorm=String(item.tipo||'').toLowerCase().trim();
        const linha={ produto:getNomeItem(item), unidade:item.unidade||'', solicitante:getSolicitante(item), valorCompra:parseValorBrToNumber(item.valorCompra), aprovador:getAprovador(item), reprovador:getReprovador(item), tipo:tipoNorm||'', status:st };
        detalhesKPIs.pedidos.push(linha);
        if(st==='reprovado'){ rejeicoes++; detalhesKPIs.rejeicoes.push(linha); } else { detalhesKPIs.aprovados.push(linha); }
        if(st==='comprado'){ compradosCount++; valorTotal+=linha.valorCompra; detalhesKPIs.gasto.push(linha); detalhesKPIs.comprados.push(linha); }
      });
      const aprovados=Math.max(0,totalPedidos-rejeicoes);
      kpiValorGasto.textContent=formatBRL(valorTotal);
      kpiQtdPedidos.textContent=totalPedidos;
      kpiQtdAprovados.textContent=aprovados;
      kpiQtdRejeicoes.textContent=rejeicoes;
      kpiQtdComprados.textContent=compradosCount;
      ajustarLayoutKPIs(tipoSel);
    }

    // [SEÇÃO] Textos KPI
    function ajustarLayoutKPIs(tipoSel){
      if(tipoSel==='produto'){
        labelValorGasto.textContent='Custo total (R$)'; descValorGasto.textContent='Somatório de produtos comprados';
        labelQtdPedidos.textContent='Solicitações de produto'; descQtdPedidos.textContent='Total de solicitações registradas';
        labelQtdAprovados.textContent='Solicitações aprovadas'; descQtdAprovados.textContent='Calculado: total − reprovadas';
        labelQtdRejeicoes.textContent='Solicitações reprovadas'; descQtdRejeicoes.textContent='Produtos não aprovados';
        labelQtdComprados.textContent='Produtos comprados'; descQtdComprados.textContent='Pedidos finalizados (status “comprado”)';
      } else if(tipoSel==='servico'){
        labelValorGasto.textContent='Custo total (R$)'; descValorGasto.textContent='Somatório de serviços contratados';
        labelQtdPedidos.textContent='Solicitações de serviço'; descQtdPedidos.textContent='Total de solicitações registradas';
        labelQtdAprovados.textContent='Solicitações aprovadas'; descQtdAprovados.textContent='Calculado: total − reprovadas';
        labelQtdRejeicoes.textContent='Solicitações reprovadas'; descQtdRejeicoes.textContent='Serviços não aprovados';
        labelQtdComprados.textContent='Serviços contratados'; descQtdComprados.textContent='Solicitações finalizadas (status “comprado”)';
      } else {
        labelValorGasto.textContent='Valor gasto total (R$)'; descValorGasto.textContent='Soma de produtos e serviços';
        labelQtdPedidos.textContent='Solicitações totais'; descQtdPedidos.textContent='Produtos + serviços solicitados';
        labelQtdAprovados.textContent='Total aprovado'; descQtdAprovados.textContent='Calculado: total − reprovadas';
        labelQtdRejeicoes.textContent='Total reprovado'; descQtdRejeicoes.textContent='Produtos + serviços reprovados';
        labelQtdComprados.textContent='Comprados'; descQtdComprados.textContent='Itens comprados / serviços contratados';
      }
      cardValorGasto.classList.remove('hidden');
      cardQtdPedidos.classList.remove('hidden');
      cardQtdAprovados.classList.remove('hidden');
      cardQtdRejeicoes.classList.remove('hidden');
      cardQtdComprados.classList.remove('hidden');
    }

    // [SEÇÃO] Gráfico
    function calcularResumoGastoPorUnidade(){
      const mesSel=(selectMes.value||'').trim(); const tipoSel=getTipoSelecionado(); const mapa=new Map();
      allItems.forEach(item=>{ const st=String(item.status||'').toLowerCase().trim(); if(st!=='comprado') return; const t=String(item.tipo||'').toLowerCase().trim(); if(tipoSel && t!==tipoSel) return; if(mesSel){ if(!item.timestamp) return; const d=new Date(item.timestamp); if(isNaN(d)) return; if(getMonthKey(d)!==mesSel) return; } const u=(item.unidade||'(sem unidade)').trim()||'(sem unidade)'; const val=parseValorBrToNumber(item.valorCompra); mapa.set(u,(mapa.get(u)||0)+val); });
      const arr=Array.from(mapa.entries()).sort((a,b)=>b[1]-a[1]); return { labels:arr.map(([u])=>u), valores:arr.map(([_,v])=>Number(v.toFixed(2))) };
    }
    function atualizarGraficoGastoPorUnidade(){ if(!ctxGastoPorUnidade) return; const {labels,valores}=calcularResumoGastoPorUnidade(); const c=chartColors(); const data={ labels, datasets:[{ label:'Total gasto (R$)', data:valores, backgroundColor:'#FD7F08', borderColor:c.barStroke, borderWidth:1, borderRadius:8, barThickness:'flex', maxBarThickness:48 }]}; const options={ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=>' '+formatBRL(ctx.parsed.y||0) } } }, scales:{ x:{ ticks:{color:c.text,maxRotation:45,minRotation:0,autoSkip:false}, grid:{display:false,borderColor:c.border} }, y:{ ticks:{color:c.text,callback:(v)=>formatBRL(v)}, grid:{color:c.grid,borderColor:c.border} } } };
      if(!gastoPorUnidadeChart){ gastoPorUnidadeChart=new Chart(ctxGastoPorUnidade,{type:'bar',data,options}); } else { gastoPorUnidadeChart.data.labels=data.labels; gastoPorUnidadeChart.data.datasets[0].data=data.datasets[0].data; gastoPorUnidadeChart.options=scalesThemeMerged(gastoPorUnidadeChart.options,c); gastoPorUnidadeChart.update(); }
    }
    function scalesThemeMerged(oldOpts,c){
      const opts = JSON.parse(JSON.stringify(oldOpts||{}));
      if(!opts.scales) opts.scales={};
      if(!opts.scales.x) opts.scales.x={};
      if(!opts.scales.y) opts.scales.y={};
      opts.scales.x.ticks = Object.assign({}, opts.scales.x.ticks, { color: c.text, maxRotation:45, minRotation:0, autoSkip:false });
      opts.scales.x.grid  = Object.assign({}, opts.scales.x.grid,  { display:false, borderColor:c.border });
      opts.scales.y.ticks = Object.assign({}, opts.scales.y.ticks, { color: c.text, callback:(v)=>formatBRL(v) });
      opts.scales.y.grid  = Object.assign({}, opts.scales.y.grid,  { color:c.grid, borderColor:c.border });
      if(opts.plugins && opts.plugins.legend){} else { opts.plugins={legend:{display:false}}; }
      return opts;
    }
    // Exposta globalmente para o script anterior trocar tema do gráfico
    window.updateChartTheme = function(){ if(gastoPorUnidadeChart){ const c=chartColors(); gastoPorUnidadeChart.options=scalesThemeMerged(gastoPorUnidadeChart.options,c); gastoPorUnidadeChart.data.datasets[0].borderColor=c.barStroke; gastoPorUnidadeChart.update(); } }

    // [SEÇÃO] Modal
    function fecharModal(){ modalOverlay.classList.add('hidden'); }
    function abrirModal(tipo){
      const tipoSel=getTipoSelecionado(); const isTudo=(tipoSel===''); let rowsHtml=''; let theadHtml=''; let descricao='';
      if(tipo==='gasto'){
        modalTitulo.textContent=isTudo?'Valor gasto total (R$)':'Custo total (R$)';
        descricao=isTudo?'Soma de produtos e serviços marcados como "comprado". A tabela indica o tipo de cada linha.':(tipoSel==='servico'?'Somatório de serviços contratados (status "comprado").':'Somatório de produtos comprados (status "comprado").');
        theadHtml=isTudo?`<tr><th class="py-2 pr-3 font-medium">Item / Serviço</th><th class="py-2 pr-3 font-medium whitespace-nowrap">Tipo</th><th class="py-2 pr-3 font-medium text-right whitespace-nowrap">Valor (R$)</th></tr>`:`<tr><th class="py-2 pr-3 font-medium">Item / Serviço</th><th class="py-2 pr-3 font-medium text-right whitespace-nowrap">Valor (R$)</th></tr>`;
        rowsHtml=detalhesKPIs.gasto.map(it=>`<tr class="text-slate-100"><td class="py-2 pr-3">${escapeHtml(it.produto)}</td>${isTudo?`<td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.tipo)}</td>`:''}<td class="py-2 pr-3 text-right">${formatBRL(it.valorCompra||0)}</td></tr>`).join('');
      }
      if(tipo==='pedidos'){
        modalTitulo.textContent=isTudo?'Solicitações totais':(tipoSel==='servico'?'Solicitações de serviço feitas':'Solicitações de produto feitas');
        descricao=isTudo?'Todas as solicitações registradas (produtos e serviços). A tabela indica o tipo.':(tipoSel==='servico'?'Total de solicitações de serviço registradas.':'Total de solicitações de produto registradas.');
        theadHtml=isTudo?`<tr><th class="py-2 pr-3 font-medium">Item / Serviço</th><th class="py-2 pr-3 font-medium whitespace-nowrap">Tipo</th><th class="py-2 pr-3 font-medium">Solicitante</th><th class="py-2 pr-3 font-medium">Unidade</th></tr>`:`<tr><th class="py-2 pr-3 font-medium">Item / Serviço</th><th class="py-2 pr-3 font-medium">Solicitante</th><th class="py-2 pr-3 font-medium">Unidade</th></tr>`;
        rowsHtml=detalhesKPIs.pedidos.map(it=>`<tr class="text-slate-100"><td class="py-2 pr-3">${escapeHtml(it.produto)}</td>${isTudo?`<td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.tipo)}</td>`:''}<td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.solicitante)}</td><td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.unidade)}</td></tr>`).join('');
      }
      if(tipo==='aprovados'){
        modalTitulo.textContent=isTudo?'Total aprovado (total − reprovadas)':'Solicitações aprovadas (total − reprovadas)';
        descricao='Lista de solicitações não reprovadas. Inclui pendentes, aprovadas e compradas.';
        theadHtml=isTudo?`<tr><th class="py-2 pr-3 font-medium">Item / Serviço</th><th class="py-2 pr-3 font-medium whitespace-nowrap">Tipo</th><th class="py-2 pr-3 font-medium">Solicitante</th><th class="py-2 pr-3 font-medium">Unidade</th><th class="py-2 pr-3 font-medium whitespace-nowrap">Status</th><th class="py-2 pr-3 font-medium">Aprovador</th></tr>`:`<tr><th class="py-2 pr-3 font-medium">Item / Serviço</th><th class="py-2 pr-3 font-medium">Solicitante</th><th class="py-2 pr-3 font-medium">Unidade</th><th class="py-2 pr-3 font-medium whitespace-nowrap">Status</th><th class="py-2 pr-3 font-medium">Aprovador</th></tr>`;
        rowsHtml=detalhesKPIs.aprovados.map(it=>`<tr class="text-slate-100"><td class="py-2 pr-3">${escapeHtml(it.produto)}</td>${isTudo?`<td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.tipo)}</td>`:''}<td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.solicitante)}</td><td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.unidade)}</td><td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.status)}</td><td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.aprovador)}</td></tr>`).join('');
      }
      if(tipo==='rejeicoes'){
        modalTitulo.textContent=isTudo?'Total reprovado':'Solicitações reprovadas';
        descricao=isTudo?'Produtos e serviços reprovados. A tabela mostra o tipo de cada linha.':(getTipoSelecionado()==='servico'?'Serviços não aprovados.':'Produtos não aprovados.');
        theadHtml=isTudo?`<tr><th class="py-2 pr-3 font-medium">Item / Serviço</th><th class="py-2 pr-3 font-medium whitespace-nowrap">Tipo</th><th class="py-2 pr-3 font-medium">Solicitante</th><th class="py-2 pr-3 font-medium">Unidade</th><th class="py-2 pr-3 font-medium">Rejeitado por</th></tr>`:`<tr><th class="py-2 pr-3 font-medium">Item / Serviço</th><th class="py-2 pr-3 font-medium">Solicitante</th><th class="py-2 pr-3 font-medium">Unidade</th><th class="py-2 pr-3 font-medium">Rejeitado por</th></tr>`;
        rowsHtml=detalhesKPIs.rejeicoes.map(it=>`<tr class="text-slate-100"><td class="py-2 pr-3">${escapeHtml(it.produto)}</td>${isTudo?`<td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.tipo)}</td>`:''}<td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.solicitante)}</td><td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.unidade)}</td><td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.reprovador)}</td></tr>`).join('');
      }
      if(tipo==='comprados'){
        modalTitulo.textContent=isTudo?'Comprados':(getTipoSelecionado()==='servico'?'Serviços contratados':'Produtos comprados');
        descricao='Solicitações finalizadas com status “comprado”.';
        theadHtml=isTudo?`<tr><th class="py-2 pr-3 font-medium">Item / Serviço</th><th class="py-2 pr-3 font-medium whitespace-nowrap">Tipo</th><th class="py-2 pr-3 font-medium">Unidade</th><th class="py-2 pr-3 font-medium text-right whitespace-nowrap">Valor (R$)</th></tr>`:`<tr><th class="py-2 pr-3 font-medium">Item / Serviço</th><th class="py-2 pr-3 font-medium">Unidade</th><th class="py-2 pr-3 font-medium text-right whitespace-nowrap">Valor (R$)</th></tr>`;
        rowsHtml=detalhesKPIs.comprados.map(it=>`<tr class="text-slate-100"><td class="py-2 pr-3">${escapeHtml(it.produto)}</td>${isTudo?`<td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.tipo)}</td>`:''}<td class="py-2 pr-3 whitespace-nowrap">${escapeHtml(it.unidade)}</td><td class="py-2 pr-3 text-right">${formatBRL(it.valorCompra||0)}</td></tr>`).join('');
      }
      if(!rowsHtml){ rowsHtml=`<tr><td class="py-4 text-center text-slate-400" colspan="99">Sem dados para este filtro.</td></tr>`; }
      modalDescricao.textContent=descricao; modalThead.innerHTML=theadHtml; modalTbody.innerHTML=rowsHtml; modalOverlay.classList.remove('hidden');
    }

    // [SEÇÃO] Backend fetch
    async function carregarDadosDoBackend(email){ if(!email) return []; if(!API_BASE) return []; try{ const url=`${API_BASE}?action=list&email=${encodeURIComponent(email)}`; const resp=await fetch(url); const data=await resp.json(); if(!data||!data.ok||!Array.isArray(data.items)) return []; return data.items; } catch(_){ return []; } }

    // [SEÇÃO] UI Events
    function atualizarTela(){ atualizarKPIs(); atualizarGraficoGastoPorUnidade(); }
    btnVoltarForm?.addEventListener('click',(e)=>{ e.preventDefault(); if(hrefForm) hrefForm.click(); else location.href="../forms/"; });
    btnSair?.addEventListener('click', async (e)=>{ e.preventDefault(); try{ await signOut(auth); }catch(_){} try{ localStorage.removeItem('sessionUser'); }catch(_){} if(hrefLogin) hrefLogin.click(); else location.href="../index.html"; });
    selectUnidade?.addEventListener('change', atualizarTela);
    selectMes?.addEventListener('change', atualizarTela);
    selectTipo?.addEventListener('change', atualizarTela);
    btnRecarregar?.addEventListener('click', async ()=>{ if(!auth.currentUser) return; startLoading(btnRecarregar); try{ const email=auth.currentUser.email||''; await carregarConfigBackend(); allItems=await carregarDadosDoBackend(email); popularFiltros(); atualizarTela(); } finally { stopLoading(btnRecarregar); } });
    cardValorGasto?.addEventListener('click',()=>abrirModal('gasto'));
    cardQtdPedidos?.addEventListener('click',()=>abrirModal('pedidos'));
    cardQtdAprovados?.addEventListener('click',()=>abrirModal('aprovados'));
    cardQtdRejeicoes?.addEventListener('click',()=>abrirModal('rejeicoes'));
    cardQtdComprados?.addEventListener('click',()=>abrirModal('comprados'));
    modalFechar?.addEventListener('click', fecharModal);
    modalOverlay?.addEventListener('click',(e)=>{ if(e.target===modalOverlay) fecharModal(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && !modalOverlay.classList.contains('hidden')) fecharModal(); });

    // [SEÇÃO] Boot/Auth
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ const hrefLoginEl = document.getElementById('hrefLogin'); if(hrefLoginEl) hrefLoginEl.click(); else location.href="../index.html"; return; }
      startLoading();
      try{ const email=user.email||''; await carregarConfigBackend(); allItems=await carregarDadosDoBackend(email); popularFiltros(); atualizarTela(); }
      finally{ stopLoading(); }
    });
  </script>
</body>
</html>
