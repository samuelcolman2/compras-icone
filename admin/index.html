<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin • Aprovação de Compras</title>

  <!-- Fonte + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Toastify -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <link rel="shortcut icon" href="https://storage.googleapis.com/ecdt-logo-saida/1ebe52af502e25d3521cb9dad62bb72f6bc1c347353cdda5fa381ef8627a9eb8/COLEGIO-E-CURSO-ICONE.webp" type="image/x-icon">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primaria: '#F1663C' },
          boxShadow: { glow: '0 0 0 3px rgba(241,102,60,0.15), 0 10px 25px -5px rgba(0,0,0,0.25)' },
        }
      }
    }
  </script>

  <style>
    html { scroll-behavior: smooth; }
    body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .badge { @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold border; }

    /* Estilo do switch tipo iOS */
    #toggleNoJustify.active { background-color: #F1663C; }
    #toggleNoJustify.active span { transform: translateX(1.25rem); }

    /* Tabs */
    .tab-btn { @apply rounded-lg px-3 py-1.5 text-sm font-semibold border transition; }
    .tab-active { @apply bg-white text-slate-900 border-white shadow; }
    .tab-idle { @apply bg-white/70 text-slate-600 border-white/60 hover:bg-white; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-orange-50 via-white to-rose-50 text-black antialiased">

  <!-- HEADER -->
  <header class="w-full max-w-7xl mx-auto pt-6 pb-2 px-4">
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img class="w-10 drop-shadow-md" src="https://iconecolegioecurso.com.br/wp-content/uploads/2022/08/xlogo_icone_site.png.pagespeed.ic_.QgXP3GszLC.webp" alt="Logo Ícone" />
        <div>
          <h1 class="text-xl sm:text-2xl font-bold">Aprovação de Compras</h1>
          <p class="text-sm text-slate-600">Painel do administrador</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span id="adminEmail" class="text-sm text-slate-700"></span>
        <button id="btnSair" class="rounded-lg bg-white border border-slate-200 px-3 py-1.5 text-sm font-semibold shadow hover:shadow-md">Sair</button>
      </div>
    </div>
  </header>

  <!-- CONTROLES -->
  <main class="w-full max-w-7xl mx-auto px-4 pb-20">
    <div class="bg-[#F1663C] border border-white/60 rounded-2xl shadow-2xl shadow-glow p-4 sm:p-6 md:p-8">

      <!-- Filtros -->
      <div class="grid grid-cols-1 lg:grid-cols-6 gap-3">
        <input id="fBusca" type="text" placeholder="Buscar por nome, e-mail, produto/serviço…" class="lg:col-span-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20" />
        <select id="fStatus" class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20">
          <option value="">Status (todos)</option>
          <option value="pendente">Pendente</option>
          <option value="aprovado">Aprovado</option>
          <option value="reprovado">Reprovado</option>
        </select>
        <select id="fUnidade" class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20">
          <option value="">Unidade (todas)</option>
          <option value="1">Unidade 1</option>
          <option value="2">Unidade 2</option>
          <option value="3">Unidade 3</option>
          <option value="4">Unidade 4</option>
          <option value="5">Unidade 5</option>
          <option value="6">Unidade 6</option>
        </select>
        <select id="fTipo" class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20">
          <option value="">Tipo (todos)</option>
          <option value="servico">Serviço</option>
          <option value="produto">Produto</option>
        </select>
        <select id="fUrgencia" class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20">
          <option value="">Urgência (todas)</option>
          <option value="baixa">Baixa</option>
          <option value="media">Média</option>
          <option value="alta">Alta</option>
          <option value="critica">Crítica</option>
        </select>
        <div class="flex gap-2">
          <button id="btnFiltrar" class="flex-1 rounded-lg bg-white px-3 py-2 text-sm font-semibold shadow hover:-translate-y-0.5 hover:shadow-md transition">Aplicar</button>
          <button id="btnLimpar" class="rounded-lg bg-white/80 px-3 py-2 text-sm font-semibold border border-white/60 hover:bg-white transition">Limpar</button>
        </div>
      </div>

      <!-- Top bar: contador + ações + tabs -->
      <div class="mt-4 flex flex-col gap-3">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm text-slate-800">
            <span id="contador"></span>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnAtualizar" class="rounded-lg bg-white px-3 py-2 text-sm font-semibold shadow hover:-translate-y-0.5 hover:shadow-md transition">Atualizar</button>
          </div>
        </div>

        <!-- Tabs: Pendentes x Histórico -->
        <div class="flex items-center gap-2">
          <button id="tabPendentes" class="tab-btn tab-active" data-tab="pendentes">Pendentes <span id="countPendentes" class="ml-1 text-xs font-semibold px-2 py-0.5 rounded-full bg-orange-100 text-orange-700">0</span></button>
          <button id="tabHistorico" class="tab-btn tab-idle" data-tab="historico">Histórico <span id="countHistorico" class="ml-1 text-xs font-semibold px-2 py-0.5 rounded-full bg-slate-100 text-slate-700">0</span></button>
        </div>
      </div>

      <!-- TABELA (reutilizada para ambas as abas) -->
      <div class="mt-4 overflow-auto border border-white/60 rounded-xl bg-white/60">
        <table class="min-w-full text-sm">
          <thead class="bg-white/70">
            <tr class="text-left">
              <th class="p-3">Enviado</th>
              <th class="p-3">Solicitante</th>
              <th class="p-3">Unidade</th>
              <th class="p-3">Tipo</th>
              <th class="p-3">Detalhes</th>
              <th class="p-3">Prazo</th>
              <th class="p-3">Urgência</th>
              <th class="p-3">Links</th>
              <th class="p-3">Status</th>
              <th class="p-3">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-slate-200 bg-white"></tbody>
        </table>
      </div>

      <!-- MODAL APROVAÇÃO/REJEIÇÃO -->
      <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
        <div class="w-full max-w-lg bg-white rounded-2xl p-4 sm:p-6 shadow-2xl">
          <h3 id="modalTitulo" class="text-lg font-bold"></h3>

          <div class="mt-2 flex items-start justify-between gap-3">
            <p id="modalHelp" class="text-sm text-slate-600 flex-1">
              Você pode adicionar uma observação.
            </p>
            <!-- TOGGLE NÃO JUSTIFICAR -->
            <label class="flex items-center gap-2 cursor-pointer select-none">
              <span class="text-xs font-medium text-slate-700">Não justificar</span>
              <div id="toggleNoJustify"
                   class="relative inline-block w-11 h-6 bg-slate-300 rounded-full transition-colors duration-300">
                <span class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transform transition-transform duration-300"></span>
              </div>
            </label>
          </div>

          <textarea
            id="modalObs"
            class="mt-3 w-full min-h-[110px] rounded-lg border border-slate-200 px-3 py-2 text-sm outline-none focus:border-primaria focus:ring-4 focus:ring-primaria/20"
            placeholder="Escreva sua observação…"
          ></textarea>

          <div class="mt-1 flex items-center justify-between">
            <span id="modalError" class="text-xs text-red-600 hidden">Informe o motivo da reprovação ou ative “Não justificar”.</span>
            <span id="modalCount" class="text-xs text-slate-500"></span>
          </div>

          <div class="mt-4 flex justify-end gap-2">
            <button id="modalCancelar" class="rounded-lg border px-3 py-2 text-sm">Cancelar</button>
            <button id="modalConfirmar" class="rounded-lg bg-primaria text-white px-3 py-2 text-sm font-semibold disabled:opacity-50 disabled:cursor-not-allowed">Confirmar</button>
          </div>
        </div>
      </div>

    </div>
  </main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  // ======= CONFIGS =======
  const firebaseConfig = {
    apiKey: "AIzaSyAEZidq8mdAUKeJXvSQeE01gVOLWe_cp78",
    authDomain: "compras-icone.firebaseapp.com",
    projectId: "compras-icone",
    storageBucket: "compras-icone.appspot.com",
    messagingSenderId: "831706842201",
    appId: "1:831706842201:web:9b68ae4f98ad93c5a99d48",
  };

  const ALLOWED_DOMAIN = 'icone.g12.br';
const ADMINS = new Set([
  'samuel.colman@icone.g12.br',
  'pedrolucas@icone.g12.br',
  'filipemarques@icone.g12.br',
].map(e => e.toLowerCase()));
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwl3Z7hmhJXtJFKng8g_8lbM2agg_mozGkpTnijydj4w2NOGFbs3kFKuQcTpJWsIvhJ/exec';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // ======= UTIL =======
  const $  = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

  function toast(msg, type='info'){
    const isSuccess = type==='success';
    const isError   = type==='error';
    Toastify({
      text: msg, duration: 3200, close: true, gravity: 'top', position: 'right', stopOnFocus: true,
      style: {
        background: isSuccess ? 'linear-gradient(90deg,#16a34a,#22c55e)'
                 : isError   ? 'linear-gradient(90deg,#dc2626,#ef4444)'
                 : 'linear-gradient(90deg,#334155,#64748b)',
        color:'#fff', fontWeight:'600', borderRadius:'10px', padding:'10px 16px',
        boxShadow:'0 10px 25px -10px rgba(0,0,0,.35)'
      }, offset: {x:8, y:10}
    }).showToast();
  }

  function fmtDate(d){
    if(!d) return '-';
    const dt = new Date(d);
    return isNaN(dt.getTime()) ? '-' : dt.toLocaleString('pt-BR');
  }

  function badgeStatus(s){
    const map = {
      pendente: 'bg-yellow-50 text-yellow-800 border-yellow-200',
      aprovado: 'bg-green-50 text-green-800 border-green-200',
      reprovado: 'bg-red-50 text-red-800 border-red-200'
    };
    return `<span class="badge ${map[s]||'bg-slate-50 text-slate-700 border-slate-200'}">${(s||'pendente').toUpperCase()}</span>`;
  }

  const debounce = (fn, wait=250)=>{ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; };

  // normaliza (remove acento/caixa) p/ busca
  const norm = (s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  function humanTipo(item){
    if(item.tipo==='servico') return `Serviço`;
    if(item.tipo==='produto') return `Produto`;
    return '-';
  }

  // ======= ESTADO =======
  let currentUser = null;
  let dadosBrutos = [];     // recebido da planilha (todos)
  let dadosFiltrados = [];  // filtrados da aba ativa
  let activeTab = 'pendentes'; // 'pendentes' | 'historico'

  // ======= AUTENTICAÇÃO =======
const isDomain = (email) => email?.toLowerCase().endsWith('@' + ALLOWED_DOMAIN);

onAuthStateChanged(auth, async (user) => {
  const adminEmailEl = $('#adminEmail');

  // 1) Precisa estar logado
  if (!user) {
    window.location.replace('../login/index.html');
    return;
  }

  // 2) Precisa ser do domínio
  if (!isDomain(user.email)) {
    await signOut(auth).catch(()=>{});
    window.location.replace('../login/index.html');
    return;
  }

  // 3) Precisa estar na lista de admins
  const isAdmin = ADMINS.has(user.email.toLowerCase());
  if (!isAdmin) {
    await signOut(auth).catch(()=>{});
    alert('Acesso restrito a administradores.');
    window.location.replace('../login/index.html');
    return;
  }

  currentUser = user;
  adminEmailEl.textContent = user.email;
  carregarLista();
});


  $('#btnSair').addEventListener('click', async ()=>{
    try{ await signOut(auth);}catch(e){}
    window.location.replace('../login/index.html');
  });

  // ======= REDE =======
  async function chamarAPI(url, opts={}){
    try{
      const resp = await fetch(url, opts);
      if(resp.type==='opaque') return { ok:true, opaque:true };
      const data = await resp.json().catch(()=>null);
      return { ok: resp.ok && (data?.ok!==false), data };
    }catch{
      try{
        await fetch(url, {...opts, mode:'no-cors'});
        return { ok:true, opaque:true };
      }catch(err){ return { ok:false, error: err?.message || String(err) }; }
    }
  }

  async function carregarLista(){
    $('#tbody').innerHTML = `<tr><td colspan="10" class="p-6 text-center text-slate-600">Carregando…</td></tr>`;
    const url = WEBAPP_URL + '?action=list';
    const { ok, data, error } = await chamarAPI(url);
    if(!ok){
      $('#tbody').innerHTML = `<tr><td colspan="10" class="p-6 text-center text-red-700">Falha ao carregar (${error||'erro'}).</td></tr>`;
      return;
    }
    dadosBrutos = Array.isArray(data?.items) ? data.items : [];
    refreshCounters();
    aplicarFiltrosERender(); // mantém filtros atuais e aba
    toast('Lista atualizada', 'success');
  }

  async function atualizarStatus(submissionId, novoStatus, observacao=''){
    const body = new URLSearchParams({
      action: 'updateStatus',
      submissionId,
      status: novoStatus,
      observacao,
      aprovador: currentUser?.email || ''
    });
    const { ok, error } = await chamarAPI(WEBAPP_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body });
    if(!ok) throw new Error(error||'Falha ao atualizar');
  }

  // ======= FILTROS =======
  function aplicaBusca(item, termo){
    if(!termo) return true;
    const hay = norm([
      item.nome, item.email, item.nomeProduto, item.descricaoServico, item.quemIndicar,
      item.unidade, item.urgencia, item.tipo
    ].filter(Boolean).join(' '));
    return hay.includes(norm(termo));
  }

  function inTab(item){
    const st = String(item.status||'pendente');
    return activeTab==='pendentes' ? (st==='pendente') : (st!=='pendente');
  }

  function aplicarFiltrosERender(){
    const q  = $('#fBusca').value.trim();
    const st = $('#fStatus').value;      // aplicado só no histórico
    const un = $('#fUnidade').value;
    const tp = $('#fTipo').value;
    const ur = $('#fUrgencia').value;

    dadosFiltrados = dadosBrutos.filter(it=>
      inTab(it) &&
      aplicaBusca(it, q) &&
      // Status: na aba Pendentes ignoramos o filtro de status; na aba Histórico respeitamos se definido
      (activeTab==='pendentes' || !st || (String(it.status||'pendente')===st)) &&
      (!un || String(it.unidade)===String(un)) &&
      (!tp || String(it.tipo)===String(tp)) &&
      (!ur || String(it.urgencia)===String(ur))
    ).sort((a,b)=> new Date(b.timestamp||0) - new Date(a.timestamp||0));

    renderTabela(dadosFiltrados);
    $('#contador').textContent = `${dadosFiltrados.length} registro(s) ${activeTab==='pendentes' ? 'pendente(s)' : 'no histórico'}`;
    refreshCounters();
  }

  function refreshCounters(){
    const pend = dadosBrutos.filter(x=>String(x.status||'pendente')==='pendente').length;
    const hist = dadosBrutos.filter(x=>String(x.status||'pendente')!=='pendente').length;
    $('#countPendentes').textContent = pend;
    $('#countHistorico').textContent = hist;
  }

  // ======= TABELA =======
  function parseLinks(links){
    if(Array.isArray(links)) return links;
    if(typeof links==='string'){
      try{ const j = JSON.parse(links); return Array.isArray(j)? j : []; }catch{ /* */ }
      return links.split(/\s+/).filter(Boolean);
    }
    return [];
  }

  function renderTabela(lista){
    const tbody = $('#tbody');
    if(!lista.length){
      tbody.innerHTML = `<tr><td colspan="10" class="p-6 text-center text-slate-600">Nenhum registro encontrado.</td></tr>`;
      return;
    }

    const popDetalhes = (it)=>{
      if(it.tipo==='produto'){
        return `
          <div class="space-y-2">
            <div class="text-xs uppercase tracking-wide text-slate-500">Produto</div>
            <div class="font-semibold">${it.nomeProduto||'-'}</div>
            <div class="text-sm">Quantidade: <span class="font-medium">${it.quantidadeProduto||'-'}</span></div>
            ${it.observacao ? `<div class="text-sm"><span class="text-slate-500">Obs:</span> ${it.observacao}</div>`:''}
          </div>`;
      }else{
        return `
          <div class="space-y-2">
            <div class="text-xs uppercase tracking-wide text-slate-500">Serviço</div>
            <div class="font-semibold">${it.descricaoServico||'-'}</div>
            ${it.quemIndicar ? `<div class="text-sm"><span class="text-slate-500">Indicação:</span> ${it.quemIndicar}</div>`:''}
            ${it.observacao ? `<div class="text-sm"><span class="text-slate-500">Obs:</span> ${it.observacao}</div>`:''}
          </div>`;
      }
    };

    const popLinks = (arr)=>{
      if(!arr.length) return `<div class="text-sm text-slate-600">Sem links.</div>`;
      return `
        <div class="space-y-2">
          <div class="text-xs uppercase tracking-wide text-slate-500">Links</div>
          <ul class="list-disc pl-5 space-y-1">
            ${arr.map((l,i)=>`<li class="break-all"><a class="underline text-primaria" href="${l}" target="_blank" rel="noopener">Link ${i+1}</a> <span class="text-xs text-slate-500 block">${l}</span></li>`).join('')}
          </ul>
        </div>`;
    };

    tbody.innerHTML = lista.map(item=>{
      const links = parseLinks(item.links);
      const prazoStr = (item.prazo==='sim' && item.dataPrazo) ? fmtDate(item.dataPrazo) : '-';

      const detalhesBreve = item.tipo==='produto'
        ? `<div><div class='font-semibold'>${item.nomeProduto||'-'}</div><div class='text-xs text-slate-600'>Qtd: ${item.quantidadeProduto||'-'}</div></div>`
        : `<div><div class='font-semibold line-clamp-2 max-w-[420px]'>${item.descricaoServico||'-'}</div>${ item.quemIndicar ? `<div class='text-xs text-slate-600 mt-0.5'>Indicação: ${item.quemIndicar}</div>`:''}</div>`;

      const showActions = (String(item.status||'pendente')==='pendente');

      const acoes = showActions ? `
        <div class='flex gap-2'>
          <button data-act='aprovar' data-id='${item.submissionId}' class='rounded-lg bg-green-600 text-white px-2.5 py-1.5 text-xs font-semibold hover:opacity-90'>Aprovar</button>
          <button data-act='reprovar' data-id='${item.submissionId}' class='rounded-lg bg-red-600 text-white px-2.5 py-1.5 text-xs font-semibold hover:opacity-90'>Reprovar</button>
        </div>` : `<div class='text-xs text-slate-500'>—</div>`;

      const statusExtra = (item.aprovadoPor||item.aprovador||item.updatedBy)
        ? `<div class='text-[11px] text-slate-600 mt-0.5'>por ${(item.aprovadoPor||item.aprovador||item.updatedBy)}${ item.aprovadoEm ? ` • ${fmtDate(item.aprovadoEm)}`:''}</div>` : '';

      const btnDetalhes = `
        <button
          type="button"
          class="js-pop inline-flex text-left max-w-[460px] hover:bg-orange-50/50 rounded px-1 -mx-1 transition"
          data-pop-title="Detalhes"
          data-pop-content="${encodeURIComponent(popDetalhes(item))}">
          ${detalhesBreve}
        </button>`;

      const btnLinks = `
        <button
          type="button"
          class="js-pop underline decoration-dotted text-primaria"
          data-pop-title="Links"
          data-pop-content="${encodeURIComponent(popLinks(links))}">
          ${links.length ? `${links.length} link(s)` : '-'}
        </button>`;

      return `<tr class='align-top'>
        <td class='p-3 whitespace-nowrap text-slate-700'>${fmtDate(item.timestamp)}</td>
        <td class='p-3'>
          <div class='font-semibold'>${item.nome||'-'}</div>
          <div class='text-xs text-slate-600'>${item.email||'-'}</div>
        </td>
        <td class='p-3'>U${item.unidade||'-'}</td>
        <td class='p-3'>${humanTipo(item)}</td>
        <td class='p-3'>${btnDetalhes}</td>
        <td class='p-3 whitespace-nowrap'>${prazoStr}</td>
        <td class='p-3 uppercase'>${(item.urgencia||'-')}</td>
        <td class='p-3'>${btnLinks}</td>
        <td class='p-3'>${badgeStatus(item.status||'pendente')}${statusExtra}${ item.observacao ? `<div class='text-xs text-slate-600 mt-0.5'>Obs: ${item.observacao}</div>`:''}</td>
        <td class='p-3'>${acoes}</td>
      </tr>`;
    }).join('');

    // Ações Aprovar/Reprovar
    tbody.querySelectorAll('button[data-act]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');
        abrirModal(id, act);
      });
    });

    // Liga popovers nos gatilhos
    tbody.querySelectorAll('.js-pop').forEach(bindPopoverTrigger);
  }

  // ======= MODAL =======
  let modalState = { id:null, act:null, noJustify:false };

  function updateNoJustifyUI(){
    const sw  = $('#toggleNoJustify');
    const ta  = $('#modalObs');
    const errorEl = $('#modalError');
    const isOn = modalState.noJustify;

    if (isOn) sw.classList.add('active'); else sw.classList.remove('active');

    if(isOn){
      ta.value = '';
      ta.setAttribute('disabled','true');
      ta.classList.add('bg-slate-100','cursor-not-allowed','opacity-70');
      errorEl.classList.add('hidden');
      $('#modalCount').textContent = '';
    }else{
      ta.removeAttribute('disabled');
      ta.classList.remove('bg-slate-100','cursor-not-allowed','opacity-70');
    }
  }

  function abrirModal(id, act){
    modalState = { id, act, noJustify:false };
    $('#modalTitulo').textContent = act==='aprovar' ? 'Confirmar aprovação' : 'Confirmar reprovação';
    $('#modalHelp').textContent = 'Você pode adicionar uma observação.';
    $('#modalObs').value='';
    $('#modalError').classList.add('hidden');
    $('#modalConfirmar').disabled = false;
    $('#toggleNoJustify')?.classList.remove('active');

    updateNoJustifyUI();

    $('#modal').classList.remove('hidden');
    $('#modal').classList.add('flex');
    setTimeout(()=> $('#modalObs').focus(), 0);
  }

  function fecharModal(){
    $('#modal').classList.add('hidden');
    $('#modal').classList.remove('flex');
    modalState = { id:null, act:null, noJustify:false };
  }

  $('#modalCancelar').addEventListener('click', fecharModal);
  $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') fecharModal(); });

  const toggleNoJustify = document.getElementById('toggleNoJustify');
  if (toggleNoJustify) {
    toggleNoJustify.addEventListener('click', () => {
      modalState.noJustify = !modalState.noJustify;
      updateNoJustifyUI();
    });
  }

  // contador + feedback ao digitar
  $('#modalObs').addEventListener('input', ()=>{
    const txt = $('#modalObs').value;
    const len = txt.trim().length;
    $('#modalCount').textContent = len ? `${len} caractere(s)` : '';
    if(len>0) $('#modalError').classList.add('hidden');
  });

  $('#modalConfirmar').addEventListener('click', async ()=>{
    const { id, act, noJustify } = modalState; if(!id||!act) return;

    const obs = noJustify ? '' : $('#modalObs').value.trim();

    if(act==='reprovar' && !noJustify && !obs){
      $('#modalError').classList.remove('hidden');
      $('#modalObs').focus();
      return;
    }

    try{
      await atualizarStatus(id, act==='aprovar' ? 'aprovado' : 'reprovado', obs);

      const alvo = dadosBrutos.find(x=>x.submissionId===id);
      if(alvo){
        alvo.status = act==='aprovar' ? 'aprovado' : 'reprovado';
        alvo.observacao = obs;
        alvo.aprovadoPor = currentUser?.email || '';
        alvo.aprovadoEm = new Date().toISOString();
      }

      // Ao aprovar/reprovar, o item sai automaticamente da aba Pendentes e passa ao Histórico
      refreshCounters();
      aplicarFiltrosERender();
      toast(act==='aprovar' ? 'Aprovado!' : 'Reprovado!', 'success');
    }catch(err){
      toast('Não foi possível atualizar: '+(err?.message||err), 'error');
    }finally{
      fecharModal();
    }
  });

  // ======= CONTROLES =======
  const aplicarFiltrosDebounced = debounce(aplicarFiltrosERender, 250);

  // Busca: aplica ao digitar (debounce) e Enter aplica na hora
  $('#fBusca').addEventListener('input', aplicarFiltrosDebounced);
  $('#fBusca').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); aplicarFiltrosERender(); } });

  // Selects: aplicam automaticamente ao mudar
  ['#fStatus','#fUnidade','#fTipo','#fUrgencia'].forEach(sel=>{ $(sel).addEventListener('change', aplicarFiltrosERender); });

  // Botões
  $('#btnFiltrar').addEventListener('click', aplicarFiltrosERender);
  $('#btnLimpar').addEventListener('click', ()=>{
    $('#fBusca').value='';
    $('#fStatus').value='';
    $('#fUnidade').value='';
    $('#fTipo').value='';
    $('#fUrgencia').value='';
    aplicarFiltrosERender();
  });
  $('#btnAtualizar').addEventListener('click', carregarLista);

  // ======= Tabs =======
  function setTab(tab){
    activeTab = tab;
    const p = $('#tabPendentes'), h = $('#tabHistorico');
    if(tab==='pendentes'){
      p.classList.add('tab-active'); p.classList.remove('tab-idle');
      h.classList.add('tab-idle');   h.classList.remove('tab-active');
      // ao ver pendentes, ignoramos filtro de status (sempre pendente)
      if($('#fStatus').value==='pendente') $('#fStatus').value='';
    }else{
      h.classList.add('tab-active'); h.classList.remove('tab-idle');
      p.classList.add('tab-idle');   p.classList.remove('tab-active');
    }
    aplicarFiltrosERender();
  }
  $('#tabPendentes').addEventListener('click', ()=> setTab('pendentes'));
  $('#tabHistorico').addEventListener('click', ()=> setTab('historico'));

  /* =======================
     Popover – utilitário
     ======================= */
  let popEl, popTitleEl, popBodyEl, popPinnedBy = null, hoverTimer=null;

  function ensurePopover(){
    if(popEl) return popEl;
    popEl = document.createElement('div');
    popEl.className = 'fixed z-[60] max-w-md w-[min(92vw,480px)] bg-white rounded-xl shadow-2xl border border-slate-200 p-3 sm:p-4 transition opacity-0 pointer-events-none';
    popEl.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div id="__pop_title" class="text-sm font-semibold"></div>
        <button type="button" id="__pop_close" class="rounded-md p-1 text-slate-500 hover:bg-slate-100" aria-label="Fechar">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293A1 1 0 1115.707 5.707L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        </button>
      </div>
      <div id="__pop_body" class="mt-2 text-sm text-slate-700"></div>
    `;
    document.body.appendChild(popEl);
    popTitleEl = popEl.querySelector('#__pop_title');
    popBodyEl  = popEl.querySelector('#__pop_body');
    popEl.querySelector('#__pop_close').addEventListener('click', ()=> hidePopover());
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hidePopover(); });
    window.addEventListener('scroll', ()=>{ if(!popPinnedBy) hidePopover(); }, true);
    window.addEventListener('resize', ()=>{ if(!popPinnedBy) hidePopover(); });
    return popEl;
  }

  function showPopoverFor(trigger){
    ensurePopover();
    const title = trigger.getAttribute('data-pop-title') || '';
    const content = decodeURIComponent(trigger.getAttribute('data-pop-content')||'');
    popTitleEl.textContent = title;
    popBodyEl.innerHTML = content;

    positionPopover(trigger);
    popEl.style.opacity = '1';
    popEl.style.pointerEvents = 'auto';
  }

  function positionPopover(trigger){
    const rect = trigger.getBoundingClientRect();
    const padding = 8;
    const vw = window.innerWidth, vh = window.innerHeight;

    let top = rect.bottom + 8;
    let left = rect.left;

    popEl.style.opacity = '0'; popEl.style.pointerEvents = 'none'; popEl.style.top='-9999px'; popEl.style.left='-9999px';
    requestAnimationFrame(()=>{
      const pw = popEl.offsetWidth, ph = popEl.offsetHeight;

      if(left + pw + padding > vw) left = Math.max(padding, vw - pw - padding);
      if(left < padding) left = padding;

      if(top + ph + padding > vh) {
        const altTop = rect.top - ph - 8;
        if(altTop >= padding) top = altTop;
        else top = Math.max(padding, vh - ph - padding);
      }

      popEl.style.left = `${left + window.scrollX}px`;
      popEl.style.top  = `${top  + window.scrollY}px`;
      popEl.style.opacity = '1';
      popEl.style.pointerEvents = 'auto';
    });
  }

  function hidePopover(){
    if(!popEl) return;
    popEl.style.opacity = '0';
    popEl.style.pointerEvents = 'none';
    popPinnedBy = null;
  }

  function bindPopoverTrigger(el){
    el.addEventListener('mouseenter', ()=>{
      if(popPinnedBy) return;
      clearTimeout(hoverTimer);
      hoverTimer = setTimeout(()=> showPopoverFor(el), 150);
    });
    el.addEventListener('mouseleave', ()=>{
      clearTimeout(hoverTimer);
      if(!popPinnedBy) hidePopover();
    });

    el.addEventListener('click', (e)=>{
      e.stopPropagation();
      const isSame = popPinnedBy === el;
      if(isSame){
        popPinnedBy = null;
        hidePopover();
      }else{
        popPinnedBy = el;
        showPopoverFor(el);
      }
    });
  }

  document.addEventListener('click', (e)=>{
    if(!popEl) return;
    if(popPinnedBy) {
      const clickedInsidePop = popEl.contains(e.target);
      const clickedTrigger   = popPinnedBy.contains(e.target);
      if(!clickedInsidePop && !clickedTrigger){
        popPinnedBy = null;
        hidePopover();
      }
    }else{
      const clickedInsidePop = popEl.contains(e.target);
      if(!clickedInsidePop) hidePopover();
    }
  });

  // Inicial: carregar via auth -> carregarLista(); setTab já está 'pendentes'
</script>

</body>
</html>
